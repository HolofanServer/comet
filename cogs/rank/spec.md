# HFS Rank システム企画書（内部向け）

## 1. 概要

HFS Rank は、HFS サーバー内の活動量に応じて XP・ランク・常連ロールを付与する自前レベリングシステムである。  
既存の ProBot ランク機能を置き換え、HFS Checkpoint 2026 以降の年次レポートとも連携する。  

- 対象サーバー: HFS 本サーバー  
- 実装場所: 既存 Bot リポジトリ `cogs/rank/`  
- データ連携: Checkpoint 用の専用 PostgreSQL（既存 cp 用 DB とテーブルレベルで共有）

## 2. コンセプトと方針

- メイン指標は「メッセージ数」  
  - HFS らしく「喋ってなんぼ」を最優先に評価する。  
- 次点で「おみくじ利用」  
  - 既存の HFS おみくじ文化を反映した“遊び要素付きブースト”。
- 最後に「VC 活動」  
  - VC はサブ要素として XP に加算するが、メッセージやおみくじよりは軽めに扱う。  

ランクシステムは年次シーズン制とし、毎年リセットする一方で、通算 XP を保持して「HFS 歴」を可視化する。[1][2]

## 3. シーズン設計

- シーズン開始日: 2026-01-01（HFS Rank シーズン 1）  
- ログ収集開始: 2025-12 以降順次開始（プレ期間）  
- ProBot ランク: 2025 年末をもって役目を終了し、新システムには引き継がない。

扱い方:

- 2025-12 〜 2025-12末: HFS Bot による XP ログを裏側で収集（本番と同じロジック / ただし“プレ期間”扱い）。  
- 2026-01-01: HFS Rank 正式リリース。ProBot ランクロールを停止・片付け、新しい Rank / 常連ロールに移行。  
- 以降毎年: 年初に `yearly_xp` とランクをリセット。`lifetime_xp` は通算として加算し続ける。[3][4]

## 4. XP ルール

### 4.1 行動別 XP 配分（v1 案）

優先度: メッセージ ＞ おみくじ ＞ VC。  

- メッセージ  
  - 条件: テキストチャンネルでの通常メッセージ。  
  - クールダウン: 1ユーザーあたり 60 秒に 1 回のみ XP 付与。  
  - XP: 1 メッセージ = 5 XP。  
  - 備考: スパム防止のため CD あり。必要なら NG チャンネル・NG ロールは除外フラグで管理。[5][6]

- おみくじ  
  - 条件: 既存のおみくじコマンド実行。  
  - 制限: 1 日 1 回まで XP 付与（2 回目以降は XP 0）。  
  - XP: 1 回 = 15 XP（メッセージ 3 通分相当）。  
  - 備考: 「毎日引くとちょっと美味しい」ブースト位置付け。[7]

- VC  
  - 条件: VC に接続している時間。  
  - 集計単位: 10 分ごとに 1 回 XP 付与。  
  - XP: 10 分 = 5 XP（メッセージ 1 通分）。  
  - 備考: “VC専業勢”はじわじわ効くが、チャット勢を超えにくいバランス。  

将来的な調整に備え、係数は DB または設定ファイル経由で変更可能な形にする。  

### 4.2 アクティブ日数

常連ロール判定に使うため、アクティブ日数を別途持つ。  

- アクティブ判定条件（1 日単位）  
  - その日に  
    - メッセージ送信 or  
    - VC に一定時間以上参加（例: 5 分以上） or  
    - おみくじ実行  
  - のいずれかを満たした場合、その日を「アクティブ 1 日」とカウント。[7]

## 5. ランク・ロール仕様

### 5.1 内部ランク（level）

- `level` は内部的な数値ランク（例: Lv.1〜50）。  
- 算出方式（例）  
  - 累積 XP から単調増加関数で算出（`level = floor(sqrt(xp) / k)` など）。  
  - HFS Rank v1 では、まず単純な段階制（閾値テーブル）から始めてもよい。  

この level は主に MyHFS / Checkpoint の表示用とし、Discord ロールはごく少数に絞る。[8][7]

### 5.2 Discord ロール

- 中間ランクロール（任意）  
  - 必要であれば、1〜2段階の“そこそこ勢”ロールを用意。  
  - 例: `HFS Member+`, `HFS Active` など（名称は別途）。  
- 常連ロール（最上位）  
  - コンセプト: 「取得が結構難しいガチ勢向け勲章」。  

#### 常連ロール条件（案）

- 条件は「XP＋アクティブ日数」の AND。  

例:  

- 年間 XP (`yearly_xp`) ≥ 10,000 XP  
- ＋ アクティブ日数 ≥ 50 日 / 年  

これにより、短期的な爆発的活動ではなく、通年での継続参加者を優先できる。[9][7]

ロール付与・剥奪は、定期バッチ（例: 15 分〜1 時間ごと）で行い、リアルタイム付与によるレートリミットリスクを避ける。[10][11]

## 6. DB 設計（概要）

Checkpoint 用 DB と同じ PostgreSQL に、Rank 向けカラム・テーブルを追加する。  

### 6.1 テーブル例

`users` テーブル（既存 / または cp と共有）に、以下のカラムを追加:  

- `yearly_xp` (int)  
  - その年の XP 合計。年初に 0 にリセット。  
- `lifetime_xp` (bigint)  
  - 通算 XP。リセットせず年ごとに加算。  
- `active_days` (int)  
  - その年のアクティブ日数。年初に 0 にリセット。  
- `current_level` (int)  
  - 内部ランク。  
- `is_regular` (bool)  
  - 常連ロール条件を満たしているかどうか（判定結果キャッシュ）。  

必要に応じて、年度別管理用の `year` カラムを持つ別テーブル  
`user_season_stats (user_id, year, yearly_xp, active_days, level, is_regular)`  
に切り出してもよい。[2][1]

### 6.2 ログテーブルとの連携

既存の cp 側で持つ予定のログテーブル（メッセージログ・VCログ・おみくじログなど）から、バッチまたはイベント駆動で XP を加算する。

- メッセージログ: `message_log (user_id, channel_id, created_at, ...)`  
- VCログ: `voice_log (user_id, joined_at, left_at, ...)`  
- おみくじログ: `omikuji_log (user_id, drawn_at, result, ...)`  

`cogs/rank/logging.py` などで Discord イベントをフックし、必要な最小情報を DB に書き込む。  

## 7. Bot 構成（cogs/rank/）

ディレクトリ構成案:  

- `cogs/rank/__init__.py`  
  - Cog ロードエントリ。  
- `cogs/rank/logging.py`  
  - Discord イベント（message/VC/join/leave/おみくじ実行）から XP ログを更新。  
  - クールダウン制御（ユーザーごと / チャンネルごと）もここで処理。  
- `cogs/rank/service.py`  
  - XP 計算ロジック（配点・係数を集約）。  
  - `add_message_xp(user_id)`, `add_vc_xp(user_id, minutes)`, `add_omikuji_xp(user_id)` など。  
- `cogs/rank/ranking.py`  
  - ランク再計算・常連判定・ロール付与/剥奪バッチ。  
  - `/rank`, `/rank top` など Rank 系コマンド。  
- `cogs/rank/models.py`  
  - DB アクセス層（SQL/ORM）。  

Checkpoint 用 cogs/cp/ とは、DB レベルで情報を共有しつつ、Cog としては完全に別モジュールとして独立させる。

## 8. Checkpoint / MyHFS との連携

### 8.1 Checkpoint カードへの反映

HFS Checkpoint 2026 カード（Web / 画像）には以下を表示する。  

- 今年の XP（`yearly_xp`）  
- 通算 HFS XP（`lifetime_xp`、2025-12〜）  
- 今年の最終ランク（level）  
- 常連ロール: 獲得 / 未獲得  
- （余裕あれば）全体順位・上位◯% など  

「年次リセットでリフレッシュされるランク」と「蓄積されるHFS歴」の両方が見えるようにする。[3][7]

### 8.2 MyHFS での常時表示

MyHFS プロフィール・カード UI には、通年で以下を表示。  

- 現在の level  
- 現在の yearly_xp / 来シーズン用の lifetime_xp  
- “HFS Rank アイコン”やバッジ（例: 常連なら特別アイコン）  

Rank の「日常の進捗」は MyHFS でいつでも確認でき、年末には Checkpoint で総まとめされる二段構えになる。[7]

## 9. リスクと対応

- レートリミット / 負荷  
  - ログ取得・XP加算は極力イベント駆動＋バッチ処理で行い、API連打を避ける。[11][10]
- スパム / XP稼ぎ行為  
  - メッセージにはクールダウンを設け、特定チャンネルや Bot コマンドチャンネルを XP 対象外にできるよう設定化。  
- バランス崩壊  
  - v1 のXP係数と常連条件は暫定とし、一定期間後に実データを見ながら再調整フェーズを企画書に明記。[7]

## 10. 今後の検討余地（v2 以降）

- リアクション数や返信先ユーザー数も XP に軽く乗せるかどうか。  
- ランク専用 Web ランキングページ `/rankings` の実装（cp 側 Web と統合）。  
- 「シーズンバッジ」機能（その年だけ貰える記念バッジ）追加。  