# ãƒ¬ãƒãƒ¼ãƒˆCogs

## C.O.M.E.T.ã«ã¤ã„ã¦

**C.O.M.E.T.**ã®åå‰ã¯ä»¥ä¸‹ã®é ­æ–‡å­—ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

- **C**ommunity of
- **O**shilove
- **M**oderation &
- **E**njoyment
- **T**ogether

HFS - ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µãƒ¼ãƒãƒ¼ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ”¯ãˆã‚‹ã€æ¨ã—æ„›ã¨ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ãã—ã¦æ¥½ã—ã•ã‚’ä¸€ç·’ã«æä¾›ã™ã‚‹ãƒœãƒƒãƒˆã§ã™ã€‚

## æ¦‚è¦

ãƒ¬ãƒãƒ¼ãƒˆCogsã¯ã€ã‚µãƒ¼ãƒãƒ¼å†…ã§ã®ä¸é©åˆ‡ãªè¡Œå‹•ã‚„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å ±å‘Šã™ã‚‹ãŸã‚ã®åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã—ã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šå ±ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±ã€è¨­å®šç®¡ç†æ©Ÿèƒ½ã‚’å«ã¿ã€ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ ã®åŠ¹ç‡çš„ãªå¯¾å¿œã‚’æ”¯æ´ã—ã¾ã™ã€‚

## Cogsæ§‹æˆ

### 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šå ± (`report_message.py`)

**ç›®çš„**: ä¸é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€šå ±ã‚·ã‚¹ãƒ†ãƒ 

**ä¸»è¦æ©Ÿèƒ½**:
- å³ã‚¯ãƒªãƒƒã‚¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚ˆã‚‹é€šå ±
- è©³ç´°ãªé€šå ±ç†ç”±ã®é¸æŠ
- ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¸ã®è‡ªå‹•é€šçŸ¥
- é€šå ±å±¥æ­´ã®è¨˜éŒ²

**å ´æ‰€**: [`cogs/report/report_message.py`](../cogs/report/report_message.py)

#### é€šå ±ç†ç”±ã‚«ãƒ†ã‚´ãƒª

| ç†ç”± | èª¬æ˜ | é‡è¦åº¦ |
|------|------|--------|
| ã‚¹ãƒ‘ãƒ  | ç¹°ã‚Šè¿”ã—æŠ•ç¨¿ã‚„å®£ä¼ | ä¸­ |
| ä¸é©åˆ‡ãªå†…å®¹ | ä¸€èˆ¬çš„ãªä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ | ä¸­ |
| ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ | å«ŒãŒã‚‰ã›ã‚„æ”»æ’ƒçš„è¡Œå‹• | é«˜ |
| ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã®æƒ…å ±å…¬é–‹ | æœ‰æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç„¡æ–­å…±æœ‰ | é«˜ |
| èª¤æƒ…å ± | è™šå½ã¾ãŸã¯èª¤è§£ã‚’æ‹›ãæƒ…å ± | ä¸­ |
| é•æ³•ãªè¡Œç‚º | æ³•çš„å•é¡Œã®ã‚ã‚‹å†…å®¹ | æœ€é«˜ |
| è‡ªå‚·/ä»–å‚·è¡Œç‚º | å±é™ºãªè¡Œç‚ºã®ä¿ƒé€² | æœ€é«˜ |
| ç”ŸæˆAIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ | ç„¡æ–­AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ | ä½ |
| å·®åˆ¥çš„ç™ºè¨€ | å·®åˆ¥ã‚„åè¦‹ã«åŸºã¥ãç™ºè¨€ | é«˜ |
| ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³ | å€‹äººæƒ…å ±ã®ç„¡æ–­å…¬é–‹ | é«˜ |
| è’ã‚‰ã—è¡Œç‚º | æ„å›³çš„ãªå¦¨å®³è¡Œç‚º | ä¸­ |
| ãã®ä»– | ä¸Šè¨˜ä»¥å¤–ã®ç†ç”± | å¤‰å‹• |

#### å®Ÿè£…è©³ç´°

```python
class ReportMessageCog(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

async def setup(bot):
    cog = ReportMessageCog(bot)
    await bot.add_cog(cog)

    async def report_message(interaction: discord.Interaction, message: discord.Message):
        # è¨­å®šã®èª­ã¿è¾¼ã¿
        from .settings import ReportSettingsCog
        mod_channel_id = await ReportSettingsCog.load_config(interaction.guild.id)
        mod_role_id = await ReportSettingsCog.load_mod_role(interaction.guild.id)

        # è¨­å®šç¢ºèª
        if mod_channel_id is None:
            await interaction.response.send_message("é€šå ±ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", ephemeral=True)
            return

        mod_channel = interaction.guild.get_channel(mod_channel_id)
        if mod_channel is None:
            await interaction.response.send_message("ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", ephemeral=True)
            return

        # é€šå ±ç†ç”±é¸æŠUI
        view = ReportReasonView(message=message, mod_channel=mod_channel)
        await interaction.response.send_message("é€šå ±ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š", view=view, ephemeral=True)
        await view.wait()

        # é€šå ±å‡¦ç†
        if view.value and view.value != "ãã®ä»–":
            await _send_report_embed(interaction, message, view.value, mod_channel, mod_role_id)

    # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç™»éŒ²
    command = app_commands.ContextMenu(
        name="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é‹å–¶ã«é€šå ±",
        callback=report_message,
        type=discord.AppCommandType.message
    )
    bot.tree.add_command(command)
```

#### é€šå ±ç†ç”±é¸æŠUI

```python
class ReportReasonSelect(discord.ui.Select):
    def __init__(self, message: discord.Message, mod_channel: discord.TextChannel):
        super().__init__()
        self.message = message
        self.mod_channel = mod_channel
        self.placeholder = 'é€šå ±ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„'
        self.options = [
            discord.SelectOption(label="ã‚¹ãƒ‘ãƒ ", value="ã‚¹ãƒ‘ãƒ "),
            discord.SelectOption(label="ä¸é©åˆ‡ãªå†…å®¹", value="ä¸é©åˆ‡ãªå†…å®¹"),
            discord.SelectOption(label="ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ", value="ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ"),
            discord.SelectOption(label="ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã®æƒ…å ±å…¬é–‹", value="ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã®æƒ…å ±å…¬é–‹"),
            discord.SelectOption(label="èª¤æƒ…å ±", value="èª¤æƒ…å ±"),
            discord.SelectOption(label="é•æ³•ãªè¡Œç‚º", value="é•æ³•ãªè¡Œç‚º"),
            discord.SelectOption(label="è‡ªå‚·/ä»–å‚·è¡Œç‚º", value="è‡ªå‚·/ä»–å‚·è¡Œç‚º"),
            discord.SelectOption(label="ç”ŸæˆAIã‚³ãƒ³ãƒ†ãƒ³ãƒ„", value="ç”ŸæˆAIã‚³ãƒ³ãƒ†ãƒ³ãƒ„"),
            discord.SelectOption(label="å·®åˆ¥çš„ç™ºè¨€", value="å·®åˆ¥çš„ç™ºè¨€"),
            discord.SelectOption(label="ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³", value="ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³"),
            discord.SelectOption(label="è’ã‚‰ã—è¡Œç‚º", value="è’ã‚‰ã—è¡Œç‚º"),
            discord.SelectOption(label="ãã®ä»–", value="ãã®ä»–"),
        ]

    async def callback(self, interaction: discord.Interaction):
        self.view.value = self.values[0]
        if self.view.value == "ãã®ä»–":
            # ã‚«ã‚¹ã‚¿ãƒ ç†ç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«
            modal = OtherReasonModal(message=self.message, mod_channel=self.mod_channel)
            await interaction.response.send_modal(modal)
        else:
            await interaction.response.send_message(f"é€šå ±ç†ç”±ã‚’ {self.view.value} ã«è¨­å®šã—ã¾ã—ãŸã€‚", ephemeral=True)
            self.view.stop()
```

#### ã‚«ã‚¹ã‚¿ãƒ ç†ç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«

```python
class OtherReasonModal(Modal):
    def __init__(self, message: discord.Message, mod_channel: discord.TextChannel):
        super().__init__(title="é€šå ±ç†ç”±ã®è©³ç´°")
        self.message = message
        self.mod_channel = mod_channel
        self.reason = TextInput(
            label="è©³ç´°ãªé€šå ±ç†ç”±", 
            style=discord.TextStyle.long, 
            placeholder="ã“ã“ã«è©³ç´°ãªé€šå ±ç†ç”±ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„...", 
            required=True
        )
        self.add_item(self.reason)

    async def on_submit(self, interaction: discord.Interaction):
        await interaction.response.send_message("é€šå ±ç†ç”±ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚", ephemeral=True)
        
        # ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼é€šçŸ¥
        mod_role = discord.utils.get(interaction.guild.roles, name="moderator")
        embed = discord.Embed(
            title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šå ±",
            description=f"{interaction.user.mention} ãŒ {self.message.jump_url} ({self.message.author.mention}) ã‚’ **ãã®ä»–ã®ç†ç”±** ã§é€šå ±ã—ã¾ã—ãŸã€‚\nç›´ã¡ã«äº‹å®Ÿç¢ºèªã‚’è¡Œã„é©åˆ‡ãªå¯¾å¿œã‚’ã—ã¦ãã ã•ã„ã€‚",
            color=0xFF0000,
            timestamp=datetime.now().astimezone(pytz.timezone('Asia/Tokyo'))
        )
        embed.add_field(name="é€šå ±ç†ç”±", value=self.reason.value, inline=False)
        embed.add_field(name="é€šå ±ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", value=f"{self.message.content}\n\n`{self.message.content}`", inline=False)
        embed.set_author(name=f"é€šå ±è€…ï¼š{interaction.user.display_name} | {interaction.user.id}\né€šå ±ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š{self.message.author.display_name} | {self.message.author.id}")
        
        await self.mod_channel.send(embed=embed, content=f"{mod_role.mention}")
        await interaction.followup.send("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé‹å–¶ã«é€šå ±ã•ã‚Œã¾ã—ãŸã€‚", ephemeral=True)
```

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ± (`report_user.py`)

**ç›®çš„**: å•é¡Œã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€šå ±ã‚·ã‚¹ãƒ†ãƒ 

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰ã®é€šå ±
- è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æ
- è¤‡æ•°é€šå ±ã®çµ±åˆç®¡ç†
- è‡ªå‹•è­¦å‘Šã‚·ã‚¹ãƒ†ãƒ é€£æº

**å®Ÿè£…ä¾‹**:

```python
class ReportUserCog(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.report_cache = {}  # ä¸€æ™‚çš„ãªé€šå ±ãƒ‡ãƒ¼ã‚¿

    @app_commands.context_menu(name="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é€šå ±")
    async def report_user(self, interaction: discord.Interaction, member: discord.Member):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼"""
        
        # è‡ªåˆ†è‡ªèº«ã‚„ç®¡ç†è€…ã®é€šå ±ã‚’é˜²ã
        if member == interaction.user:
            await interaction.response.send_message("è‡ªåˆ†è‡ªèº«ã‚’é€šå ±ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚", ephemeral=True)
            return
        
        if member.guild_permissions.administrator:
            await interaction.response.send_message("ç®¡ç†è€…ã‚’é€šå ±ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚", ephemeral=True)
            return
        
        # é€šå ±ç†ç”±é¸æŠ
        view = UserReportReasonView(member)
        await interaction.response.send_message(
            f"{member.mention} ã‚’é€šå ±ã™ã‚‹ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š", 
            view=view, 
            ephemeral=True
        )

class UserReportReasonView(discord.ui.View):
    def __init__(self, target_member: discord.Member):
        super().__init__()
        self.target_member = target_member
        self.add_item(UserReportReasonSelect(target_member))

class UserReportReasonSelect(discord.ui.Select):
    def __init__(self, target_member: discord.Member):
        super().__init__()
        self.target_member = target_member
        self.placeholder = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±ç†ç”±ã‚’é¸æŠ'
        self.options = [
            discord.SelectOption(label="ç¶™ç¶šçš„ãªãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ", value="harassment", emoji="ğŸš«"),
            discord.SelectOption(label="ã‚¹ãƒ‘ãƒ è¡Œç‚º", value="spam", emoji="ğŸ“¢"),
            discord.SelectOption(label="ä¸é©åˆ‡ãªãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«", value="inappropriate_profile", emoji="ğŸ‘¤"),
            discord.SelectOption(label="ãƒ«ãƒ¼ãƒ«é•åã®ç¹°ã‚Šè¿”ã—", value="rule_violation", emoji="âš ï¸"),
            discord.SelectOption(label="è’ã‚‰ã—è¡Œç‚º", value="trolling", emoji="ğŸ­"),
            discord.SelectOption(label="å·®åˆ¥çš„è¡Œå‹•", value="discrimination", emoji="âš–ï¸"),
            discord.SelectOption(label="ãã®ä»–", value="other", emoji="â“"),
        ]

    async def callback(self, interaction: discord.Interaction):
        reason = self.values[0]
        
        if reason == "other":
            # ã‚«ã‚¹ã‚¿ãƒ ç†ç”±å…¥åŠ›
            modal = UserReportModal(self.target_member)
            await interaction.response.send_modal(modal)
        else:
            # å®šå‹ç†ç”±ã§ã®é€šå ±
            await self._process_user_report(interaction, reason)

    async def _process_user_report(self, interaction: discord.Interaction, reason: str):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±ã®å‡¦ç†"""
        reason_map = {
            "harassment": "ç¶™ç¶šçš„ãªãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ",
            "spam": "ã‚¹ãƒ‘ãƒ è¡Œç‚º",
            "inappropriate_profile": "ä¸é©åˆ‡ãªãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«",
            "rule_violation": "ãƒ«ãƒ¼ãƒ«é•åã®ç¹°ã‚Šè¿”ã—",
            "trolling": "è’ã‚‰ã—è¡Œç‚º",
            "discrimination": "å·®åˆ¥çš„è¡Œå‹•"
        }
        
        reason_text = reason_map.get(reason, reason)
        
        # ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ³ãƒãƒ«ã«é€šçŸ¥
        await self._send_user_report_notification(interaction, reason_text)
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²
        await self._record_user_report(interaction, reason)
        
        await interaction.response.send_message(
            f"{self.target_member.mention} ã®é€šå ±ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚", 
            ephemeral=True
        )

    async def _send_user_report_notification(self, interaction: discord.Interaction, reason: str):
        """ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¸ã®é€šçŸ¥"""
        from .settings import ReportSettingsCog
        mod_channel_id = await ReportSettingsCog.load_config(interaction.guild.id)
        
        if not mod_channel_id:
            return
        
        mod_channel = interaction.guild.get_channel(mod_channel_id)
        if not mod_channel:
            return
        
        embed = discord.Embed(
            title="ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±",
            description=f"{interaction.user.mention} ãŒ {self.target_member.mention} ã‚’é€šå ±ã—ã¾ã—ãŸã€‚",
            color=0xFF6600,
            timestamp=datetime.now().astimezone(pytz.timezone('Asia/Tokyo'))
        )
        
        embed.add_field(name="é€šå ±ç†ç”±", value=reason, inline=False)
        embed.add_field(name="é€šå ±ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼", value=f"{self.target_member.mention}\nID: {self.target_member.id}", inline=True)
        embed.add_field(name="é€šå ±è€…", value=f"{interaction.user.mention}\nID: {interaction.user.id}", inline=True)
        embed.add_field(name="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ—¥", value=self.target_member.created_at.strftime("%Y-%m-%d"), inline=True)
        embed.add_field(name="ã‚µãƒ¼ãƒãƒ¼å‚åŠ æ—¥", value=self.target_member.joined_at.strftime("%Y-%m-%d"), inline=True)
        
        # éå»ã®é€šå ±å±¥æ­´
        past_reports = await self._get_past_reports(self.target_member.id)
        if past_reports > 0:
            embed.add_field(name="âš ï¸ éå»ã®é€šå ±", value=f"{past_reports}ä»¶", inline=True)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«æƒ…å ±
        roles = [role.name for role in self.target_member.roles if role.name != "@everyone"]
        if roles:
            embed.add_field(name="ãƒ­ãƒ¼ãƒ«", value=", ".join(roles[:5]), inline=False)
        
        await mod_channel.send(embed=embed)

    async def _record_user_report(self, interaction: discord.Interaction, reason: str):
        """é€šå ±ã®è¨˜éŒ²"""
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é€šå ±ã‚’è¨˜éŒ²
        # å®Ÿè£…ã¯å…·ä½“çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã«ä¾å­˜
        pass

    async def _get_past_reports(self, user_id: int) -> int:
        """éå»ã®é€šå ±ä»¶æ•°ã‚’å–å¾—"""
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰éå»ã®é€šå ±ä»¶æ•°ã‚’å–å¾—
        # å®Ÿè£…ã¯å…·ä½“çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã«ä¾å­˜
        return 0
```

### 3. è¨­å®šç®¡ç† (`settings.py`)

**ç›®çš„**: ãƒ¬ãƒãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šç®¡ç†

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ³ãƒãƒ«ã®è¨­å®š
- ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ«ã®è¨­å®š
- é€šå ±è¨­å®šã®ç®¡ç†
- è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š

**å®Ÿè£…ä¾‹**:

```python
class ReportSettingsCog(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.config_cache = {}

    @app_commands.command(name="report_setup", description="é€šå ±ã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®š")
    @app_commands.describe(
        channel="ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«",
        role="ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ«"
    )
    async def setup_report_system(
        self, 
        interaction: discord.Interaction, 
        channel: discord.TextChannel,
        role: discord.Role
    ):
        """é€šå ±ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸè¨­å®š"""
        
        # æ¨©é™ãƒã‚§ãƒƒã‚¯
        if not interaction.user.guild_permissions.manage_guild:
            await interaction.response.send_message("ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
            return
        
        # è¨­å®šã®ä¿å­˜
        await self.save_config(interaction.guild.id, channel.id)
        await self.save_mod_role(interaction.guild.id, role.id)
        
        embed = discord.Embed(
            title="âœ… é€šå ±ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå®Œäº†",
            description="é€šå ±ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚",
            color=0x00FF00
        )
        embed.add_field(name="ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ³ãƒãƒ«", value=channel.mention, inline=True)
        embed.add_field(name="ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ«", value=role.mention, inline=True)
        
        await interaction.response.send_message(embed=embed)

    @staticmethod
    async def load_config(guild_id: int) -> Optional[int]:
        """ã‚®ãƒ«ãƒ‰ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿"""
        try:
            with open(f"config/report_config_{guild_id}.json", "r") as f:
                config = json.load(f)
                return config.get("mod_channel_id")
        except FileNotFoundError:
            return None

    @staticmethod
    async def save_config(guild_id: int, channel_id: int):
        """ã‚®ãƒ«ãƒ‰ã®è¨­å®šã‚’ä¿å­˜"""
        config = {"mod_channel_id": channel_id}
        os.makedirs("config", exist_ok=True)
        with open(f"config/report_config_{guild_id}.json", "w") as f:
            json.dump(config, f, indent=2)

    @staticmethod
    async def load_mod_role(guild_id: int) -> Optional[int]:
        """ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ«IDã‚’èª­ã¿è¾¼ã¿"""
        try:
            with open(f"config/report_config_{guild_id}.json", "r") as f:
                config = json.load(f)
                return config.get("mod_role_id")
        except FileNotFoundError:
            return None

    @staticmethod
    async def save_mod_role(guild_id: int, role_id: int):
        """ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ«IDã‚’ä¿å­˜"""
        try:
            with open(f"config/report_config_{guild_id}.json", "r") as f:
                config = json.load(f)
        except FileNotFoundError:
            config = {}
        
        config["mod_role_id"] = role_id
        os.makedirs("config", exist_ok=True)
        with open(f"config/report_config_{guild_id}.json", "w") as f:
            json.dump(config, f, indent=2)

    @app_commands.command(name="report_stats", description="é€šå ±çµ±è¨ˆã®è¡¨ç¤º")
    async def show_report_stats(self, interaction: discord.Interaction):
        """é€šå ±çµ±è¨ˆã®è¡¨ç¤º"""
        
        # æ¨©é™ãƒã‚§ãƒƒã‚¯
        mod_role_id = await self.load_mod_role(interaction.guild.id)
        if mod_role_id:
            mod_role = interaction.guild.get_role(mod_role_id)
            if mod_role not in interaction.user.roles and not interaction.user.guild_permissions.manage_guild:
                await interaction.response.send_message("ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
                return
        
        # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        stats = await self._get_report_statistics(interaction.guild.id)
        
        embed = discord.Embed(
            title="ğŸ“Š é€šå ±çµ±è¨ˆ",
            description="éå»30æ—¥é–“ã®é€šå ±çµ±è¨ˆ",
            color=0x0099FF
        )
        
        embed.add_field(name="ç·é€šå ±æ•°", value=stats.get("total_reports", 0), inline=True)
        embed.add_field(name="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šå ±", value=stats.get("message_reports", 0), inline=True)
        embed.add_field(name="ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±", value=stats.get("user_reports", 0), inline=True)
        
        # æœ€ã‚‚å¤šã„é€šå ±ç†ç”±
        top_reasons = stats.get("top_reasons", [])
        if top_reasons:
            reasons_text = "\n".join([f"{i+1}. {reason['name']}: {reason['count']}ä»¶" for i, reason in enumerate(top_reasons[:5])])
            embed.add_field(name="ä¸»ãªé€šå ±ç†ç”±", value=reasons_text, inline=False)
        
        await interaction.response.send_message(embed=embed)

    async def _get_report_statistics(self, guild_id: int) -> Dict[str, Any]:
        """é€šå ±çµ±è¨ˆã®å–å¾—"""
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰çµ±è¨ˆã‚’å–å¾—
        # å®Ÿè£…ã¯å…·ä½“çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã«ä¾å­˜
        return {
            "total_reports": 0,
            "message_reports": 0,
            "user_reports": 0,
            "top_reasons": []
        }
```

## é€šå ±å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šå ±ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³ã‚¯ãƒªãƒƒã‚¯
   â†“
2. "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é‹å–¶ã«é€šå ±" ã‚’é¸æŠ
   â†“
3. é€šå ±ç†ç”±é¸æŠUIè¡¨ç¤º
   â†“
4. ç†ç”±é¸æŠ or ã‚«ã‚¹ã‚¿ãƒ ç†ç”±å…¥åŠ›
   â†“
5. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ³ãƒãƒ«ã«é€šçŸ¥
   â†“
6. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²
   â†“
7. ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
```

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯
   â†“
2. "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é€šå ±" ã‚’é¸æŠ
   â†“
3. é€šå ±ç†ç”±é¸æŠUIè¡¨ç¤º
   â†“
4. ç†ç”±é¸æŠ or ã‚«ã‚¹ã‚¿ãƒ ç†ç”±å…¥åŠ›
   â†“
5. éå»ã®é€šå ±å±¥æ­´ç¢ºèª
   â†“
6. ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ³ãƒãƒ«ã«é€šçŸ¥
   â†“
7. è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®š
   â†“
8. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### é€šå ±ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

```sql
-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šå ±ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE message_reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    guild_id INTEGER NOT NULL,
    reporter_id INTEGER NOT NULL,
    reported_message_id INTEGER NOT NULL,
    reported_user_id INTEGER NOT NULL,
    channel_id INTEGER NOT NULL,
    reason TEXT NOT NULL,
    custom_reason TEXT,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP,
    resolved_by INTEGER,
    resolution_note TEXT
);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šå ±ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE user_reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    guild_id INTEGER NOT NULL,
    reporter_id INTEGER NOT NULL,
    reported_user_id INTEGER NOT NULL,
    reason TEXT NOT NULL,
    custom_reason TEXT,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP,
    resolved_by INTEGER,
    resolution_note TEXT
);

-- é€šå ±è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE report_settings (
    guild_id INTEGER PRIMARY KEY,
    mod_channel_id INTEGER,
    mod_role_id INTEGER,
    auto_action_enabled BOOLEAN DEFAULT FALSE,
    auto_action_threshold INTEGER DEFAULT 3,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½

### 1. é–¾å€¤ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

```python
class AutoActionManager:
    def __init__(self, bot):
        self.bot = bot
        self.action_thresholds = {
            "warning": 2,      # 2å›é€šå ±ã§è­¦å‘Š
            "timeout": 3,      # 3å›é€šå ±ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            "kick": 5,         # 5å›é€šå ±ã§ã‚­ãƒƒã‚¯
            "ban": 7           # 7å›é€šå ±ã§BAN
        }

    async def check_auto_action(self, guild_id: int, user_id: int):
        """è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®š"""
        report_count = await self._get_recent_report_count(guild_id, user_id)
        
        for action, threshold in self.action_thresholds.items():
            if report_count >= threshold:
                await self._execute_auto_action(guild_id, user_id, action)
                break

    async def _execute_auto_action(self, guild_id: int, user_id: int, action: str):
        """è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ"""
        guild = self.bot.get_guild(guild_id)
        member = guild.get_member(user_id)
        
        if not member:
            return
        
        if action == "warning":
            await self._send_warning(member)
        elif action == "timeout":
            await self._timeout_member(member)
        elif action == "kick":
            await self._kick_member(member)
        elif action == "ban":
            await self._ban_member(member)

    async def _get_recent_report_count(self, guild_id: int, user_id: int) -> int:
        """æœ€è¿‘ã®é€šå ±ä»¶æ•°ã‚’å–å¾—"""
        # éå»7æ—¥é–“ã®é€šå ±ä»¶æ•°ã‚’å–å¾—
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…ã«ä¾å­˜
        return 0
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

### 1. é€šå ±ã‚¹ãƒ‘ãƒ é˜²æ­¢

```python
class ReportSpamProtection:
    def __init__(self):
        self.report_cooldowns = {}  # user_id -> last_report_time
        self.cooldown_duration = 300  # 5åˆ†

    def can_report(self, user_id: int) -> bool:
        """é€šå ±å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯"""
        now = time.time()
        last_report = self.report_cooldowns.get(user_id, 0)
        
        if now - last_report < self.cooldown_duration:
            return False
        
        self.report_cooldowns[user_id] = now
        return True

    def get_remaining_cooldown(self, user_id: int) -> int:
        """æ®‹ã‚Šã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ™‚é–“ã‚’å–å¾—"""
        now = time.time()
        last_report = self.report_cooldowns.get(user_id, 0)
        remaining = self.cooldown_duration - (now - last_report)
        return max(0, int(remaining))
```

### 2. è™šå½é€šå ±æ¤œå‡º

```python
class FalseReportDetector:
    def __init__(self):
        self.false_report_threshold = 3

    async def check_false_reports(self, reporter_id: int, guild_id: int) -> bool:
        """è™šå½é€šå ±ã®æ¤œå‡º"""
        false_reports = await self._count_false_reports(reporter_id, guild_id)
        
        if false_reports >= self.false_report_threshold:
            await self._handle_false_reporter(reporter_id, guild_id)
            return True
        
        return False

    async def _count_false_reports(self, reporter_id: int, guild_id: int) -> int:
        """è™šå½é€šå ±ä»¶æ•°ã®å–å¾—"""
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰è™šå½é€šå ±ä»¶æ•°ã‚’å–å¾—
        return 0

    async def _handle_false_reporter(self, reporter_id: int, guild_id: int):
        """è™šå½é€šå ±è€…ã¸ã®å¯¾å¿œ"""
        # é€šå ±æ©Ÿèƒ½ã®ä¸€æ™‚åœæ­¢ãªã©
        pass
```

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Cogsã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](01-cogs-architecture.md)
- [ç®¡ç†Cogs](04-management-cogs.md)
- [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](../02-core/04-error-handling.md)
- [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†](../04-utilities/01-database-management.md)
