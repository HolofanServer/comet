# 管理Cogs

## C.O.M.E.T.について

**C.O.M.E.T.**の名前は以下の頭文字から構成されています：

- **C**ommunity of
- **O**shilove
- **M**oderation &
- **E**njoyment
- **T**ogether

HFS - ホロライブ非公式ファンサーバーのコミュニティを支える、推し愛とモデレーション、そして楽しさを一緒に提供するボットです。

## 概要

管理Cogsは、ボット制御、Cog管理、データベース操作、ヘルプシステムの管理機能を提供します。

## 利用可能な管理Cogs

### 1. Cog管理 (`manage_cogs.py`)

**目的**: ボット拡張の動的ロード、アンロード、リロード。

**主要機能**:
- **ホットリロード**: ボットを再起動せずにCogsをリロード
- **拡張管理**: 個別Cogのロード/アンロード
- **エラーハンドリング**: 拡張失敗の優雅な処理
- **インタラクティブインターフェース**: 簡単管理のためのスラッシュコマンド

**利用可能なコマンド**:
- `/reload_cog`: 特定のCogをリロード
- `/load_cog`: 新しいCogをロード
- `/unload_cog`: 既存のCogをアンロード
- `/list_cogs`: ロード済みのすべてのCogをリスト表示

### 2. データベースマイグレーションコマンド (`db_migration_commands.py`)

**目的**: データベーススキーマ管理とマイグレーション操作。

**主要機能**:
- **スキーマバージョニング**: データベーススキーマ変更を追跡
- **マイグレーションスクリプト**: データベース更新を安全に適用
- **ロールバックサポート**: 問題のあるマイグレーションを元に戻す
- **データ整合性**: マイグレーション中のデータ一貫性を確保

**利用可能なコマンド**:
- `/migrate`: 保留中のデータベースマイグレーションを適用
- `/rollback`: 最後のマイグレーションをロールバック
- `/migration_status`: 現在のマイグレーション状態をチェック

### 3. ヘルプシステム (`help.py`)

**目的**: 拡張フォーマット付きカスタムヘルプコマンド実装。

**主要機能**:
- **カテゴリ化されたコマンド**: 機能別にコマンドを整理
- **インタラクティブヘルプ**: 詳細なコマンド説明と使用法
- **権限認識**: アクセス可能なコマンドのみ表示
- **リッチフォーマット**: 拡張された視覚的プレゼンテーション

**利用可能なコマンド**:
- `/help`: 一般的なヘルプ情報を表示
- `/help <command>`: 特定のコマンドの詳細ヘルプを取得
- `/help <category>`: カテゴリ内のコマンドを表示

### 4. ボット管理 (`manage_bot.py`)

**目的**: コアボット管理と管理操作。

**主要機能**:
- **ボット制御**: 再起動、シャットダウン、ステータス操作
- **システム情報**: ボット統計と健全性を表示
- **設定管理**: ランタイム設定更新
- **メンテナンスモード**: 一時的なボットメンテナンス状態

**利用可能なコマンド**:
- `/bot_status`: ボットの健全性と統計を表示
- `/restart_bot`: ボットを再起動（オーナーのみ）
- `/shutdown_bot`: ボットを優雅にシャットダウン（オーナーのみ）
- `/maintenance`: メンテナンスモードを切り替え

### 5. スタッフDMシステム (`anonymous_dm.py`)

**目的**: スタッフとユーザー間の高機能DMサポートツール。

**主要機能**:
- **スタッフDM**: スタッフとしてユーザーとDMやり取り
- **メッセージ同期**: 編集・削除の双方向同期
- **内部メモ**: 相手に見えないメモ機能
- **スニペット**: 定型文の管理と送信
- **セッション管理**: 優先度・タグ・統計機能
- **タイピング通知**: リアルタイムタイピング表示

**利用可能なコマンド**:
- `/anondm setup`: DMカテゴリを設定
- `/anondm start`: ユーザーとのDMセッションを開始
- `/anondm snippet`: スニペット（定型文）を管理
- `/anondm sessions`: アクティブセッション一覧を表示

### 6. AutoPurgeシステム (`auto_purge.py`)

**目的**: 多彩なフィルター条件でメッセージを一括削除。

**主要機能**:
- **条件付き削除**: ユーザー、BOT、リンク、添付ファイル等でフィルタリング
- **自動削除**: 定期的な自動削除タスク
- **ドライラン**: 削除前に対象件数を確認
- **確認UI**: 削除前の確認ダイアログ

**利用可能なコマンド**:
- `/purge messages`: 条件付きメッセージ削除
- `/purge user`: 特定ユーザーのメッセージを削除
- `/purge bots`: BOTのメッセージを削除
- `/purge links`: リンク含むメッセージを削除
- `/purge attachments`: 添付ファイル付きメッセージを削除
- `/autopurge set`: 自動削除ルールを設定
- `/autopurge list`: 自動削除ルール一覧
- `/autopurge remove`: 自動削除ルールを削除
- `/autopurge toggle`: 自動削除の有効/無効切り替え

### 7. チャンネルミュートシステム (`channel_mute_system.py`)

**目的**: チャンネル権限を使った特定ユーザーの発言禁止。

**主要機能**:
- **全チャンネルミュート**: 全テキストチャンネルで発言禁止
- **除外チャンネル**: 特定チャンネルのみ発言許可
- **自動適用**: 新規チャンネル作成時に自動でミュート適用
- **ログ機能**: ミュート操作のログ記録

**利用可能なコマンド**:
- `cmute add`: ユーザーをチャンネルミュートに追加
- `cmute remove`: ミュートを解除
- `cmute exclude`: 除外チャンネルを追加
- `cmute unexclude`: 除外チャンネルを削除
- `cmute list`: ミュート中のユーザー一覧
- `cmute status`: ユーザーの詳細を表示
- `cmute logchannel`: ログ送信先を設定
- `cmute refresh`: 権限を再適用

### 8. 地震チャンネルシステム (`earthquake_channel.py`)

**目的**: P2P地震情報APIと連携した地震情報通知と一時チャンネル公開。

**主要機能**:
- **WebSocket監視**: P2P地震情報APIからリアルタイム受信
- **自動オープン**: 震度3以上で地震チャンネルを自動公開
- **ロール付与**: ボタンクリックで閲覧ロールを付与
- **自動クローズ**: 24時間後に自動でチャンネルをクローズ
- **サンドボックス対応**: テスト用サンドボックスモード

**利用可能なコマンド**:
- `/earthquake setup`: 地震チャンネルシステムを設定
- `/earthquake open`: 手動でチャンネルをオープン
- `/earthquake close`: チャンネルをクローズ
- `/earthquake status`: 現在の状態を表示

### 9. イベントログシステム (`event_logger.py`)

**目的**: サーバー内イベントをフォーラムチャンネルに自動記録。

**主要機能**:
- **カテゴリ別ログ**: メンバー、モデレーション、メッセージ、ボイス、サーバー
- **フォーラム投稿**: イベントタイプごとにスレッドを自動作成
- **ビットフラグ設定**: 記録するイベントを細かく選択可能
- **BOT除外**: BOTのイベントを除外するオプション

**対応イベント**:
- メンバー: 参加、退出、BAN、キック、タイムアウト、ロール変更、ニックネーム変更
- メッセージ: 削除、一括削除、編集
- ボイス: 参加、退出、移動
- サーバー: チャンネル作成/削除/更新、ロール作成/削除/更新

**利用可能なコマンド**:
- `/eventlog setup`: イベントログを設定
- `/eventlog disable`: イベントログを無効化
- `/eventlog status`: 現在の設定を表示
- `/eventlog ignore_bots`: BOT除外の切り替え

### 10. タグモデレーション (`tag_moderation.py`)

**目的**: サーバータグ（クラン）ベースの自動モデレーション。

**主要機能**:
- **自動検出**: サーバー参加時にタグを自動チェック
- **禁止タグリスト**: 禁止するタグを管理
- **自動タイムアウト**: 禁止タグ検出時に自動でタイムアウト
- **警告通知**: 指定チャンネルに警告を送信
- **ログ記録**: モデレーションアクションを記録

**利用可能なコマンド**:
- `/tagmod add`: 禁止タグを追加
- `/tagmod remove`: 禁止タグを削除
- `/tagmod list`: 禁止タグ一覧を表示
- `/tagmod setchannel`: 警告送信先を設定
- `/tagmod toggle`: モデレーション機能のON/OFF
- `/tagmod status`: 現在の設定を表示

## コマンド構造

### 権限レベル
管理コマンドは厳格な権限チェックを使用します:

```python
# Owner-only commands
@is_owner()

# Administrator permissions
@commands.has_permissions(administrator=True)

# Guild-specific commands
@is_guild()
```

### エラーハンドリング
すべての管理コマンドは包括的なエラーハンドリングを含みます:

```python
try:
    # Command logic
    await operation()
    await interaction.response.send_message("✅ Operation successful")
except Exception as e:
    logger.error(f"Management command failed: {e}")
    await interaction.response.send_message(f"❌ Operation failed: {e}")
```

### ログ統合
管理操作は監査目的でログに記録されます:

```python
@log_commands()
async def management_command(self, interaction):
    # Command execution is automatically logged
    pass
```

## セキュリティ考慮事項

### アクセス制御
- **オーナー検証**: 重要な操作にはボットオーナーステータスが必要
- **権限チェック**: コマンドはDiscord権限を検証
- **ギルド制限**: 一部のコマンドは特定のギルドに制限

### 監査証跡
- **コマンドログ**: すべての管理コマンドがログに記録
- **エラー追跡**: 失敗はコンテキストと共に記録
- **変更履歴**: データベースマイグレーションは履歴を維持

### 安全な操作
- **優雅な劣化**: 失敗した操作はボットをクラッシュさせない
- **ロールバック機能**: データベース変更は元に戻すことが可能
- **確認プロンプト**: 破壊的操作には確認が必要

## 使用例

### Cog管理
```
/reload_cog cog:user_analyzer
/load_cog cog:new_feature
/unload_cog cog:deprecated_feature
```

### データベース操作
```
/migrate
/migration_status
/rollback
```

### ボット制御
```
/bot_status
/maintenance mode:on
/restart_bot
```

---

## 関連ドキュメント

- [メインボットクラス](../02-core/01-main-bot-class.md)
- [データベース管理](../04-utilities/01-database-management.md)
- [エラーハンドリング](../02-core/04-error-handling.md)
- [セキュリティガイドライン](../05-development/03-security-guidelines.md)
