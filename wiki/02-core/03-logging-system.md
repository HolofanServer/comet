# ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 

## C.O.M.E.T.ã«ã¤ã„ã¦

**C.O.M.E.T.**ã®åå‰ã¯ä»¥ä¸‹ã®é ­æ–‡å­—ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

- **C**ommunity of
- **O**shilove
- **M**oderation &
- **E**njoyment
- **T**ogether

HFS - ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µãƒ¼ãƒãƒ¼ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ”¯ãˆã‚‹ã€æ¨ã—æ„›ã¨ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ãã—ã¦æ¥½ã—ã•ã‚’ä¸€ç·’ã«æä¾›ã™ã‚‹ãƒœãƒƒãƒˆã§ã™ã€‚

## æ¦‚è¦

COMETãƒœãƒƒãƒˆã®ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¯ã€åŒ…æ‹¬çš„ãªãƒ­ã‚°è¨˜éŒ²ã€æ§‹é€ åŒ–ãƒ­ã‚°ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã€ãƒ­ã‚°åˆ†ææ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚é–‹ç™ºã€ãƒ‡ãƒãƒƒã‚°ã€é‹ç”¨ç›£è¦–ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã®ã™ã¹ã¦ã®ãƒ‹ãƒ¼ã‚ºã«å¯¾å¿œã—ã¾ã™ã€‚

## ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ­ã‚°ç”Ÿæˆå±¤ (Log Generation)                                 â”‚
â”‚  â”œâ”€â”€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°                                    â”‚
â”‚  â”œâ”€â”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°                                        â”‚
â”‚  â”œâ”€â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ­ã‚°                                      â”‚
â”‚  â””â”€â”€ ç›£æŸ»ãƒ­ã‚°                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ­ã‚°å‡¦ç†å±¤ (Log Processing)                                 â”‚
â”‚  â”œâ”€â”€ ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼                                      â”‚
â”‚  â”œâ”€â”€ ãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼                                          â”‚
â”‚  â”œâ”€â”€ ãƒ­ã‚°ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼                                      â”‚
â”‚  â””â”€â”€ ãƒ­ã‚°ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ­ã‚°é…ä¿¡å±¤ (Log Distribution)                               â”‚
â”‚  â”œâ”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼                                      â”‚
â”‚  â”œâ”€â”€ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼                                    â”‚
â”‚  â”œâ”€â”€ Webhookãƒãƒ³ãƒ‰ãƒ©ãƒ¼                                       â”‚
â”‚  â””â”€â”€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ­ã‚°ä¿å­˜å±¤ (Log Storage)                                    â”‚
â”‚  â”œâ”€â”€ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«                                        â”‚
â”‚  â”œâ”€â”€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹                                            â”‚
â”‚  â”œâ”€â”€ å¤–éƒ¨ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹                                        â”‚
â”‚  â””â”€â”€ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ­ã‚°è¨­å®šã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ãƒ­ã‚°è¨­å®šã‚¯ãƒ©ã‚¹

**å ´æ‰€**: [`utils/logging.py`](../utils/logging.py)

```python
import logging
import logging.handlers
import json
import os
from datetime import datetime
from typing import Dict, Any, Optional
import pytz

class COMETLogger:
    def __init__(self, name: str = "COMET", level: str = "INFO"):
        self.name = name
        self.level = getattr(logging, level.upper())
        self.logger = self._setup_logger()
        self.session_id = self._generate_session_id()
        
    def _setup_logger(self) -> logging.Logger:
        """ãƒ­ã‚¬ãƒ¼ã®åˆæœŸåŒ–"""
        logger = logging.getLogger(self.name)
        logger.setLevel(self.level)
        
        # æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        logger.handlers.clear()
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã®è¨­å®š
        formatter = self._create_formatter()
        
        # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        console_handler = logging.StreamHandler()
        console_handler.setLevel(self.level)
        console_handler.setFormatter(formatter)
        logger.addHandler(console_handler)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        file_handler = self._create_file_handler()
        file_handler.setLevel(self.level)
        file_handler.setFormatter(formatter)
        logger.addHandler(file_handler)
        
        # ã‚¨ãƒ©ãƒ¼å°‚ç”¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        error_handler = self._create_error_handler()
        error_handler.setLevel(logging.ERROR)
        error_handler.setFormatter(formatter)
        logger.addHandler(error_handler)
        
        return logger
    
    def _create_formatter(self) -> logging.Formatter:
        """ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã®ä½œæˆ"""
        format_string = (
            '%(asctime)s - %(name)s - %(levelname)s - '
            '[%(filename)s:%(lineno)d] - %(message)s'
        )
        
        formatter = logging.Formatter(
            format_string,
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        
        # æ—¥æœ¬æ™‚é–“ã®è¨­å®š
        formatter.converter = lambda *args: datetime.now(
            pytz.timezone('Asia/Tokyo')
        ).timetuple()
        
        return formatter
    
    def _create_file_handler(self) -> logging.handlers.RotatingFileHandler:
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä½œæˆ"""
        log_dir = "logs"
        os.makedirs(log_dir, exist_ok=True)
        
        log_file = os.path.join(log_dir, f"{self.name.lower()}.log")
        
        handler = logging.handlers.RotatingFileHandler(
            log_file,
            maxBytes=10 * 1024 * 1024,  # 10MB
            backupCount=5,
            encoding='utf-8'
        )
        
        return handler
    
    def _create_error_handler(self) -> logging.handlers.RotatingFileHandler:
        """ã‚¨ãƒ©ãƒ¼å°‚ç”¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä½œæˆ"""
        log_dir = "logs"
        error_file = os.path.join(log_dir, f"{self.name.lower()}_error.log")
        
        handler = logging.handlers.RotatingFileHandler(
            error_file,
            maxBytes=5 * 1024 * 1024,  # 5MB
            backupCount=10,
            encoding='utf-8'
        )
        
        return handler
    
    def _generate_session_id(self) -> str:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®ç”Ÿæˆ"""
        import uuid
        return str(uuid.uuid4())[:8]
```

### 2. æ§‹é€ åŒ–ãƒ­ã‚°

```python
class StructuredLogger:
    def __init__(self, base_logger: logging.Logger):
        self.base_logger = base_logger
        self.default_fields = {
            "service": "COMET",
            "version": "2.1.0",
            "environment": os.getenv("ENVIRONMENT", "development")
        }
    
    def log_structured(self, level: str, message: str, **kwargs) -> None:
        """æ§‹é€ åŒ–ãƒ­ã‚°ã®å‡ºåŠ›"""
        log_data = {
            "timestamp": datetime.now(pytz.timezone('Asia/Tokyo')).isoformat(),
            "level": level.upper(),
            "message": message,
            **self.default_fields,
            **kwargs
        }
        
        # JSONã¨ã—ã¦å‡ºåŠ›
        json_message = json.dumps(log_data, ensure_ascii=False, separators=(',', ':'))
        
        log_level = getattr(logging, level.upper())
        self.base_logger.log(log_level, json_message)
    
    def info(self, message: str, **kwargs) -> None:
        self.log_structured("info", message, **kwargs)
    
    def warning(self, message: str, **kwargs) -> None:
        self.log_structured("warning", message, **kwargs)
    
    def error(self, message: str, **kwargs) -> None:
        self.log_structured("error", message, **kwargs)
    
    def debug(self, message: str, **kwargs) -> None:
        self.log_structured("debug", message, **kwargs)
    
    def critical(self, message: str, **kwargs) -> None:
        self.log_structured("critical", message, **kwargs)
```

### 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°

```python
class EventLogger:
    def __init__(self, structured_logger: StructuredLogger):
        self.logger = structured_logger
    
    async def log_command_execution(self, ctx, command_name: str, success: bool, duration: float = None) -> None:
        """ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒ­ã‚°"""
        event_data = {
            "event_type": "command_execution",
            "command": command_name,
            "user_id": ctx.author.id,
            "user_name": str(ctx.author),
            "guild_id": ctx.guild.id if ctx.guild else None,
            "guild_name": ctx.guild.name if ctx.guild else None,
            "channel_id": ctx.channel.id,
            "success": success,
            "duration_ms": duration * 1000 if duration else None
        }
        
        if success:
            self.logger.info("Command executed successfully", **event_data)
        else:
            self.logger.warning("Command execution failed", **event_data)
    
    async def log_user_action(self, action: str, user_id: int, guild_id: int = None, **metadata) -> None:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚°"""
        event_data = {
            "event_type": "user_action",
            "action": action,
            "user_id": user_id,
            "guild_id": guild_id,
            "metadata": metadata
        }
        
        self.logger.info("User action logged", **event_data)
    
    async def log_system_event(self, event: str, severity: str = "info", **details) -> None:
        """ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°"""
        event_data = {
            "event_type": "system_event",
            "event": event,
            "severity": severity,
            "details": details
        }
        
        log_method = getattr(self.logger, severity.lower(), self.logger.info)
        log_method("System event occurred", **event_data)
    
    async def log_error_event(self, error: Exception, context: Dict[str, Any] = None) -> None:
        """ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°"""
        import traceback
        
        event_data = {
            "event_type": "error_event",
            "error_type": type(error).__name__,
            "error_message": str(error),
            "traceback": traceback.format_exc(),
            "context": context or {}
        }
        
        self.logger.error("Error occurred", **event_data)
```

## å°‚ç”¨ãƒ­ã‚°ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

### 1. Webhookãƒãƒ³ãƒ‰ãƒ©ãƒ¼

```python
import aiohttp
import asyncio
from logging import Handler, LogRecord

class WebhookHandler(Handler):
    def __init__(self, webhook_url: str, level: int = logging.ERROR):
        super().__init__(level)
        self.webhook_url = webhook_url
        self.session = None
        
    async def emit_async(self, record: LogRecord) -> None:
        """éåŒæœŸã§Webhookã«ãƒ­ã‚°ã‚’é€ä¿¡"""
        try:
            if not self.session:
                self.session = aiohttp.ClientSession()
            
            # ãƒ­ã‚°ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            message = self.format(record)
            
            # Discord Webhookå½¢å¼
            payload = {
                "content": f"```\n{message}\n```",
                "embeds": [{
                    "title": f"{record.levelname} - {record.name}",
                    "description": record.getMessage(),
                    "color": self._get_color_for_level(record.levelno),
                    "timestamp": datetime.fromtimestamp(record.created).isoformat(),
                    "fields": [
                        {
                            "name": "ãƒ•ã‚¡ã‚¤ãƒ«",
                            "value": f"{record.filename}:{record.lineno}",
                            "inline": True
                        },
                        {
                            "name": "é–¢æ•°",
                            "value": record.funcName,
                            "inline": True
                        }
                    ]
                }]
            }
            
            async with self.session.post(
                self.webhook_url,
                json=payload,
                timeout=aiohttp.ClientTimeout(total=10)
            ) as response:
                if response.status != 204:
                    print(f"Webhooké€ä¿¡å¤±æ•—: {response.status}")
                    
        except Exception as e:
            print(f"Webhooké€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
    
    def emit(self, record: LogRecord) -> None:
        """åŒæœŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"""
        try:
            loop = asyncio.get_event_loop()
            loop.create_task(self.emit_async(record))
        except RuntimeError:
            # ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ãªã„å ´åˆ
            asyncio.run(self.emit_async(record))
    
    def _get_color_for_level(self, level: int) -> int:
        """ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè‰²ã‚’å–å¾—"""
        colors = {
            logging.DEBUG: 0x808080,    # ã‚°ãƒ¬ãƒ¼
            logging.INFO: 0x0099FF,     # é’
            logging.WARNING: 0xFF9900,  # ã‚ªãƒ¬ãƒ³ã‚¸
            logging.ERROR: 0xFF0000,    # èµ¤
            logging.CRITICAL: 0x990000  # æš—èµ¤
        }
        return colors.get(level, 0x000000)
    
    async def close(self) -> None:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
        if self.session:
            await self.session.close()
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

```python
class DatabaseHandler(Handler):
    def __init__(self, db_service, level: int = logging.INFO):
        super().__init__(level)
        self.db_service = db_service
        
    async def emit_async(self, record: LogRecord) -> None:
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ­ã‚°ã‚’ä¿å­˜"""
        try:
            log_data = {
                "timestamp": datetime.fromtimestamp(record.created).isoformat(),
                "level": record.levelname,
                "logger_name": record.name,
                "message": record.getMessage(),
                "filename": record.filename,
                "line_number": record.lineno,
                "function_name": record.funcName,
                "thread_id": record.thread,
                "process_id": record.process
            }
            
            # ä¾‹å¤–æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
            if record.exc_info:
                import traceback
                log_data["exception"] = traceback.format_exception(*record.exc_info)
            
            query = """
            INSERT INTO logs (
                timestamp, level, logger_name, message, filename, 
                line_number, function_name, thread_id, process_id, 
                exception, created_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """
            
            await self.db_service.execute_query(
                query,
                (
                    log_data["timestamp"],
                    log_data["level"],
                    log_data["logger_name"],
                    log_data["message"],
                    log_data["filename"],
                    log_data["line_number"],
                    log_data["function_name"],
                    log_data["thread_id"],
                    log_data["process_id"],
                    json.dumps(log_data.get("exception")),
                    datetime.now().isoformat()
                )
            )
            
        except Exception as e:
            print(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
    
    def emit(self, record: LogRecord) -> None:
        """åŒæœŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"""
        try:
            loop = asyncio.get_event_loop()
            loop.create_task(self.emit_async(record))
        except RuntimeError:
            asyncio.run(self.emit_async(record))
```

## ãƒ­ã‚°åˆ†æã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### 1. ãƒ­ã‚°åˆ†æå™¨

```python
class LogAnalyzer:
    def __init__(self, db_service):
        self.db_service = db_service
    
    async def get_error_summary(self, hours: int = 24) -> Dict[str, Any]:
        """ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼ã®å–å¾—"""
        query = """
        SELECT 
            level,
            COUNT(*) as count,
            logger_name,
            filename
        FROM logs 
        WHERE 
            timestamp > datetime('now', '-{} hours')
            AND level IN ('ERROR', 'CRITICAL')
        GROUP BY level, logger_name, filename
        ORDER BY count DESC
        """.format(hours)
        
        results = await self.db_service.fetch_all(query, ())
        
        summary = {
            "total_errors": sum(row["count"] for row in results),
            "error_breakdown": results,
            "top_error_sources": results[:5]
        }
        
        return summary
    
    async def get_command_usage_stats(self, days: int = 7) -> Dict[str, Any]:
        """ã‚³ãƒãƒ³ãƒ‰ä½¿ç”¨çµ±è¨ˆã®å–å¾—"""
        query = """
        SELECT 
            JSON_EXTRACT(message, '$.command') as command,
            COUNT(*) as usage_count,
            AVG(CAST(JSON_EXTRACT(message, '$.duration_ms') AS REAL)) as avg_duration_ms
        FROM logs 
        WHERE 
            timestamp > datetime('now', '-{} days')
            AND JSON_EXTRACT(message, '$.event_type') = 'command_execution'
            AND JSON_EXTRACT(message, '$.success') = 1
        GROUP BY command
        ORDER BY usage_count DESC
        """.format(days)
        
        results = await self.db_service.fetch_all(query, ())
        
        return {
            "total_commands": sum(row["usage_count"] for row in results),
            "command_stats": results,
            "most_used_commands": results[:10]
        }
    
    async def detect_anomalies(self) -> List[Dict[str, Any]]:
        """ç•°å¸¸ã®æ¤œå‡º"""
        anomalies = []
        
        # ã‚¨ãƒ©ãƒ¼ç‡ã®æ€¥å¢—
        error_rate = await self._calculate_error_rate()
        if error_rate > 0.1:  # 10%ä»¥ä¸Š
            anomalies.append({
                "type": "high_error_rate",
                "value": error_rate,
                "threshold": 0.1,
                "description": "ã‚¨ãƒ©ãƒ¼ç‡ãŒç•°å¸¸ã«é«˜ããªã£ã¦ã„ã¾ã™"
            })
        
        # å¿œç­”æ™‚é–“ã®å¢—åŠ 
        avg_response_time = await self._calculate_avg_response_time()
        if avg_response_time > 5000:  # 5ç§’ä»¥ä¸Š
            anomalies.append({
                "type": "slow_response_time",
                "value": avg_response_time,
                "threshold": 5000,
                "description": "å¹³å‡å¿œç­”æ™‚é–“ãŒç•°å¸¸ã«é•·ããªã£ã¦ã„ã¾ã™"
            })
        
        return anomalies
    
    async def _calculate_error_rate(self) -> float:
        """ã‚¨ãƒ©ãƒ¼ç‡ã®è¨ˆç®—"""
        query = """
        SELECT 
            COUNT(CASE WHEN level IN ('ERROR', 'CRITICAL') THEN 1 END) * 1.0 / COUNT(*) as error_rate
        FROM logs 
        WHERE timestamp > datetime('now', '-1 hour')
        """
        
        result = await self.db_service.fetch_one(query, ())
        return result["error_rate"] if result else 0.0
    
    async def _calculate_avg_response_time(self) -> float:
        """å¹³å‡å¿œç­”æ™‚é–“ã®è¨ˆç®—"""
        query = """
        SELECT AVG(CAST(JSON_EXTRACT(message, '$.duration_ms') AS REAL)) as avg_duration
        FROM logs 
        WHERE 
            timestamp > datetime('now', '-1 hour')
            AND JSON_EXTRACT(message, '$.event_type') = 'command_execution'
            AND JSON_EXTRACT(message, '$.duration_ms') IS NOT NULL
        """
        
        result = await self.db_service.fetch_one(query, ())
        return result["avg_duration"] if result else 0.0
```

### 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–

```python
class LogMonitor:
    def __init__(self, log_analyzer: LogAnalyzer, notification_service):
        self.log_analyzer = log_analyzer
        self.notification_service = notification_service
        self.monitoring_active = False
        
    async def start_monitoring(self, interval: int = 300) -> None:
        """ç›£è¦–ã®é–‹å§‹ï¼ˆ5åˆ†é–“éš”ï¼‰"""
        self.monitoring_active = True
        
        while self.monitoring_active:
            try:
                await self._check_system_health()
                await asyncio.sleep(interval)
            except Exception as e:
                logger.error(f"ç›£è¦–ã‚¨ãƒ©ãƒ¼: {e}")
                await asyncio.sleep(60)  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯1åˆ†å¾Œã«å†è©¦è¡Œ
    
    def stop_monitoring(self) -> None:
        """ç›£è¦–ã®åœæ­¢"""
        self.monitoring_active = False
    
    async def _check_system_health(self) -> None:
        """ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
        # ç•°å¸¸æ¤œå‡º
        anomalies = await self.log_analyzer.detect_anomalies()
        
        if anomalies:
            await self._handle_anomalies(anomalies)
        
        # ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼
        error_summary = await self.log_analyzer.get_error_summary(hours=1)
        
        if error_summary["total_errors"] > 10:  # 1æ™‚é–“ã§10å€‹ä»¥ä¸Šã®ã‚¨ãƒ©ãƒ¼
            await self._handle_high_error_count(error_summary)
    
    async def _handle_anomalies(self, anomalies: List[Dict[str, Any]]) -> None:
        """ç•°å¸¸ã¸ã®å¯¾å¿œ"""
        for anomaly in anomalies:
            message = f"ğŸš¨ ç•°å¸¸æ¤œå‡º: {anomaly['description']}\n"
            message += f"å€¤: {anomaly['value']}\n"
            message += f"é–¾å€¤: {anomaly['threshold']}"
            
            await self.notification_service.send_alert(
                title="ã‚·ã‚¹ãƒ†ãƒ ç•°å¸¸æ¤œå‡º",
                message=message,
                severity="HIGH"
            )
    
    async def _handle_high_error_count(self, error_summary: Dict[str, Any]) -> None:
        """é«˜ã‚¨ãƒ©ãƒ¼æ•°ã¸ã®å¯¾å¿œ"""
        message = f"âš ï¸ é«˜ã‚¨ãƒ©ãƒ¼æ•°æ¤œå‡º\n"
        message += f"éå»1æ™‚é–“ã®ã‚¨ãƒ©ãƒ¼æ•°: {error_summary['total_errors']}\n"
        message += f"ä¸»ãªã‚¨ãƒ©ãƒ¼æº:\n"
        
        for error in error_summary["top_error_sources"][:3]:
            message += f"- {error['filename']}: {error['count']}ä»¶\n"
        
        await self.notification_service.send_alert(
            title="é«˜ã‚¨ãƒ©ãƒ¼æ•°æ¤œå‡º",
            message=message,
            severity="MEDIUM"
        )
```

## ãƒ­ã‚°è¨­å®šã®åˆæœŸåŒ–

### setup_logging é–¢æ•°

```python
def setup_logging(name: str = "COMET", level: str = None) -> logging.Logger:
    """ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–"""
    if level is None:
        level = os.getenv("LOG_LEVEL", "INFO")
    
    # COMETLoggerã®åˆæœŸåŒ–
    comet_logger = COMETLogger(name, level)
    base_logger = comet_logger.logger
    
    # æ§‹é€ åŒ–ãƒ­ã‚°ã®è¿½åŠ 
    structured_logger = StructuredLogger(base_logger)
    
    # ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã®è¿½åŠ 
    event_logger = EventLogger(structured_logger)
    
    # Webhookãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¿½åŠ ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿ï¼‰
    webhook_url = os.getenv("ERROR_WEBHOOK_URL")
    if webhook_url:
        webhook_handler = WebhookHandler(webhook_url, logging.ERROR)
        base_logger.addHandler(webhook_handler)
    
    # ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã®è¿½åŠ 
    base_logger.structured = structured_logger
    base_logger.events = event_logger
    base_logger.session_id = comet_logger.session_id
    
    return base_logger

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ã‚¬ãƒ¼ã®åˆæœŸåŒ–
logger = setup_logging()
```

## ãƒ­ã‚°ä½¿ç”¨ä¾‹

### 1. åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•

```python
from utils.logging import setup_logging

logger = setup_logging("MyCog")

# åŸºæœ¬ãƒ­ã‚°
logger.info("Cog initialized successfully")
logger.warning("Configuration value missing, using default")
logger.error("Failed to connect to external service")

# æ§‹é€ åŒ–ãƒ­ã‚°
logger.structured.info(
    "User command executed",
    user_id=123456789,
    command="ping",
    guild_id=987654321,
    duration_ms=150
)

# ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
await logger.events.log_command_execution(ctx, "ping", True, 0.15)
await logger.events.log_user_action("role_assigned", user_id=123456789, role="moderator")
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ã®ä½¿ç”¨

```python
try:
    result = await some_operation()
    logger.structured.info("Operation completed", operation="some_operation", result=result)
except Exception as e:
    await logger.events.log_error_event(
        e, 
        context={
            "operation": "some_operation",
            "user_id": ctx.author.id,
            "guild_id": ctx.guild.id
        }
    )
    raise
```

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](04-error-handling.md)
- [ãƒ¡ã‚¤ãƒ³ãƒœãƒƒãƒˆã‚¯ãƒ©ã‚¹](01-main-bot-class.md)
- [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†](../04-utilities/01-database-management.md)
- [ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ](../03-cogs/08-monitoring-cogs.md)
