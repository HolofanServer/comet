# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

## C.O.M.E.T.ã«ã¤ã„ã¦

**C.O.M.E.T.**ã®åå‰ã¯ä»¥ä¸‹ã®é ­æ–‡å­—ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

- **C**ommunity of
- **O**shilove
- **M**oderation &
- **E**njoyment
- **T**ogether

HFS - ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µãƒ¼ãƒãƒ¼ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ”¯ãˆã‚‹ã€æ¨ã—æ„›ã¨ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ãã—ã¦æ¥½ã—ã•ã‚’ä¸€ç·’ã«æä¾›ã™ã‚‹ãƒœãƒƒãƒˆã§ã™ã€‚

## æ¦‚è¦

COMETãƒœãƒƒãƒˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¯ã€åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼æ•æ‰ã€åˆ†é¡ã€å ±å‘Šã€å¾©æ—§æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã‚’æãªã†ã“ã¨ãªãã€ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ã¨ä¿¡é ¼æ€§ã‚’ç¢ºä¿ã—ã¾ã™ã€‚

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã‚¨ãƒ©ãƒ¼æ¤œå‡ºå±¤ (Error Detection)                              â”‚
â”‚  â”œâ”€â”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼                              â”‚
â”‚  â”œâ”€â”€ Cogãƒ¬ãƒ™ãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼                               â”‚
â”‚  â”œâ”€â”€ ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒ™ãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼                          â”‚
â”‚  â””â”€â”€ ä¾‹å¤–ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã‚¨ãƒ©ãƒ¼åˆ†é¡å±¤ (Error Classification)                        â”‚
â”‚  â”œâ”€â”€ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼                                          â”‚
â”‚  â”œâ”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ©ãƒ¼                                          â”‚
â”‚  â”œâ”€â”€ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼                                      â”‚
â”‚  â””â”€â”€ è¨­å®šã‚¨ãƒ©ãƒ¼                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã‚¨ãƒ©ãƒ¼å‡¦ç†å±¤ (Error Processing)                            â”‚
â”‚  â”œâ”€â”€ ã‚¨ãƒ©ãƒ¼åˆ†æ                                              â”‚
â”‚  â”œâ”€â”€ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåé›†                                        â”‚
â”‚  â”œâ”€â”€ é‡è¦åº¦åˆ¤å®š                                              â”‚
â”‚  â””â”€â”€ å¾©æ—§æˆ¦ç•¥æ±ºå®š                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã‚¨ãƒ©ãƒ¼å ±å‘Šå±¤ (Error Reporting)                             â”‚
â”‚  â”œâ”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥                                            â”‚
â”‚  â”œâ”€â”€ ç®¡ç†è€…ã‚¢ãƒ©ãƒ¼ãƒˆ                                          â”‚
â”‚  â”œâ”€â”€ ãƒ­ã‚°è¨˜éŒ²                                                â”‚
â”‚  â””â”€â”€ å¤–éƒ¨ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é€£æº                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã‚¨ãƒ©ãƒ¼å¾©æ—§å±¤ (Error Recovery)                              â”‚
â”‚  â”œâ”€â”€ è‡ªå‹•å¾©æ—§                                                â”‚
â”‚  â”œâ”€â”€ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†                                      â”‚
â”‚  â”œâ”€â”€ éƒ¨åˆ†æ©Ÿèƒ½åœæ­¢                                            â”‚
â”‚  â””â”€â”€ æ‰‹å‹•ä»‹å…¥è¦æ±‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

### 1. ãƒ¡ã‚¤ãƒ³ãƒœãƒƒãƒˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

**å ´æ‰€**: [`main.py:143-176`](../main.py)

```python
class MyBot(commands.AutoShardedBot):
    @commands.Cog.listener()
    async def on_command_error(self, ctx: commands.Context, error: commands.CommandError) -> None:
        """ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"""
        if hasattr(ctx, 'handled') and ctx.handled:
            return
        
        # ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åé›†
        error_context = {
            "command": {
                "name": ctx.command.name if ctx.command else "unknown",
                "content": ctx.message.content,
                "cog": ctx.cog.__class__.__name__ if ctx.cog else None
            },
            "user": {
                "id": ctx.author.id,
                "name": str(ctx.author),
                "bot": ctx.author.bot
            },
            "channel": {
                "id": ctx.channel.id,
                "name": getattr(ctx.channel, 'name', 'DM'),
                "type": str(ctx.channel.type)
            }
        }
        
        if ctx.guild:
            error_context["guild"] = {
                "id": ctx.guild.id,
                "name": ctx.guild.name,
                "member_count": ctx.guild.member_count
            }
        
        # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        handled = await handle_command_error(ctx, error, self.ERROR_LOG_CHANNEL_ID, error_context)
        if handled:
            ctx.handled = True
    
    @commands.Cog.listener()
    async def on_application_command_error(self, interaction: discord.Interaction, error: commands.CommandError) -> None:
        """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"""
        error_context = {
            "command": {
                "name": interaction.command.name if interaction.command else "unknown",
                "type": "application_command"
            },
            "user": {
                "id": interaction.user.id,
                "name": str(interaction.user)
            },
            "guild": {
                "id": interaction.guild.id,
                "name": interaction.guild.name
            } if interaction.guild else None
        }
        
        await handle_application_command_error(interaction, error, error_context)
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°

**å ´æ‰€**: [`utils/error.py`](../utils/error.py)

```python
import discord
from discord.ext import commands
import traceback
import logging
from datetime import datetime
from typing import Dict, Any, Optional, Union
import pytz

logger = logging.getLogger(__name__)

async def handle_command_error(
    ctx: commands.Context, 
    error: commands.CommandError, 
    error_channel_id: int,
    context: Dict[str, Any] = None
) -> bool:
    """ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ã®çµ±åˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"""
    
    error_info = ErrorAnalyzer.analyze_error(error, context)
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¿œç­”
    user_message = await _generate_user_message(error_info)
    if user_message:
        try:
            await ctx.send(user_message, ephemeral=True)
        except discord.HTTPException:
            pass  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ
    
    # ãƒ­ã‚°è¨˜éŒ²
    await _log_error(error_info, ctx)
    
    # ç®¡ç†è€…é€šçŸ¥ï¼ˆé‡è¦ãªã‚¨ãƒ©ãƒ¼ã®ã¿ï¼‰
    if error_info.severity in ['HIGH', 'CRITICAL']:
        await _notify_administrators(error_info, error_channel_id, ctx)
    
    # è‡ªå‹•å¾©æ—§ã®è©¦è¡Œ
    if error_info.recoverable:
        recovery_success = await _attempt_recovery(error_info, ctx)
        if recovery_success:
            logger.info(f"Error recovery successful for {error_info.error_type}")
    
    return True

async def handle_application_command_error(
    interaction: discord.Interaction,
    error: commands.CommandError,
    context: Dict[str, Any] = None
) -> bool:
    """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"""
    
    error_info = ErrorAnalyzer.analyze_error(error, context)
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¿œç­”
    user_message = await _generate_user_message(error_info)
    if user_message:
        try:
            if interaction.response.is_done():
                await interaction.followup.send(user_message, ephemeral=True)
            else:
                await interaction.response.send_message(user_message, ephemeral=True)
        except discord.HTTPException:
            pass
    
    # ãƒ­ã‚°è¨˜éŒ²
    await _log_interaction_error(error_info, interaction)
    
    return True
```

## ã‚¨ãƒ©ãƒ¼åˆ†æã‚·ã‚¹ãƒ†ãƒ 

### 1. ã‚¨ãƒ©ãƒ¼åˆ†æå™¨

```python
from enum import Enum
from dataclasses import dataclass
from typing import List, Optional

class ErrorSeverity(Enum):
    LOW = "LOW"
    MEDIUM = "MEDIUM"
    HIGH = "HIGH"
    CRITICAL = "CRITICAL"

class ErrorCategory(Enum):
    USER_ERROR = "USER_ERROR"
    SYSTEM_ERROR = "SYSTEM_ERROR"
    EXTERNAL_ERROR = "EXTERNAL_ERROR"
    CONFIGURATION_ERROR = "CONFIGURATION_ERROR"
    PERMISSION_ERROR = "PERMISSION_ERROR"

@dataclass
class ErrorInfo:
    error_type: str
    error_message: str
    category: ErrorCategory
    severity: ErrorSeverity
    recoverable: bool
    user_friendly_message: str
    technical_details: Dict[str, Any]
    suggested_actions: List[str]
    context: Dict[str, Any]

class ErrorAnalyzer:
    @staticmethod
    def analyze_error(error: Exception, context: Dict[str, Any] = None) -> ErrorInfo:
        """ã‚¨ãƒ©ãƒ¼ã®è©³ç´°åˆ†æ"""
        error_type = type(error).__name__
        error_message = str(error)
        
        # ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®åˆ†æ
        if isinstance(error, commands.CommandNotFound):
            return ErrorInfo(
                error_type=error_type,
                error_message=error_message,
                category=ErrorCategory.USER_ERROR,
                severity=ErrorSeverity.LOW,
                recoverable=True,
                user_friendly_message="ãã®ã‚³ãƒãƒ³ãƒ‰ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚`/help`ã§åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
                technical_details={"command": error_message},
                suggested_actions=["ã‚³ãƒãƒ³ãƒ‰åã‚’ç¢ºèª", "ãƒ˜ãƒ«ãƒ—ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨"],
                context=context or {}
            )
        
        elif isinstance(error, commands.MissingRequiredArgument):
            return ErrorInfo(
                error_type=error_type,
                error_message=error_message,
                category=ErrorCategory.USER_ERROR,
                severity=ErrorSeverity.LOW,
                recoverable=True,
                user_friendly_message=f"å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `{error.param.name}` ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚",
                technical_details={"missing_param": error.param.name},
                suggested_actions=["ã‚³ãƒãƒ³ãƒ‰ã®ä½¿ç”¨æ–¹æ³•ã‚’ç¢ºèª", "å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ "],
                context=context or {}
            )
        
        elif isinstance(error, commands.MissingPermissions):
            return ErrorInfo(
                error_type=error_type,
                error_message=error_message,
                category=ErrorCategory.PERMISSION_ERROR,
                severity=ErrorSeverity.MEDIUM,
                recoverable=False,
                user_friendly_message="ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
                technical_details={"missing_permissions": error.missing_permissions},
                suggested_actions=["ç®¡ç†è€…ã«æ¨©é™ã‚’ç¢ºèª", "é©åˆ‡ãªãƒ­ãƒ¼ãƒ«ã‚’å–å¾—"],
                context=context or {}
            )
        
        elif isinstance(error, commands.BotMissingPermissions):
            return ErrorInfo(
                error_type=error_type,
                error_message=error_message,
                category=ErrorCategory.CONFIGURATION_ERROR,
                severity=ErrorSeverity.HIGH,
                recoverable=True,
                user_friendly_message="ãƒœãƒƒãƒˆã«å¿…è¦ãªæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
                technical_details={"missing_permissions": error.missing_permissions},
                suggested_actions=["ãƒœãƒƒãƒˆæ¨©é™ã‚’ç¢ºèª", "ç®¡ç†è€…ã«é€£çµ¡"],
                context=context or {}
            )
        
        elif isinstance(error, commands.CommandOnCooldown):
            return ErrorInfo(
                error_type=error_type,
                error_message=error_message,
                category=ErrorCategory.USER_ERROR,
                severity=ErrorSeverity.LOW,
                recoverable=True,
                user_friendly_message=f"ã‚³ãƒãƒ³ãƒ‰ã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã§ã™ã€‚{error.retry_after:.1f}ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
                technical_details={"retry_after": error.retry_after, "cooldown_type": str(error.cooldown.type)},
                suggested_actions=["ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ"],
                context=context or {}
            )
        
        elif isinstance(error, discord.HTTPException):
            return ErrorInfo(
                error_type=error_type,
                error_message=error_message,
                category=ErrorCategory.EXTERNAL_ERROR,
                severity=ErrorSeverity.HIGH,
                recoverable=True,
                user_friendly_message="Discord APIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
                technical_details={"status": error.status, "code": error.code},
                suggested_actions=["ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ", "ç®¡ç†è€…ã«å ±å‘Š"],
                context=context or {}
            )
        
        elif isinstance(error, discord.Forbidden):
            return ErrorInfo(
                error_type=error_type,
                error_message=error_message,
                category=ErrorCategory.PERMISSION_ERROR,
                severity=ErrorSeverity.HIGH,
                recoverable=False,
                user_friendly_message="ãƒœãƒƒãƒˆã«ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
                technical_details={"discord_error": str(error)},
                suggested_actions=["ãƒœãƒƒãƒˆæ¨©é™ã‚’ç¢ºèª", "ç®¡ç†è€…ã«é€£çµ¡"],
                context=context or {}
            )
        
        else:
            # æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼
            return ErrorInfo(
                error_type=error_type,
                error_message=error_message,
                category=ErrorCategory.SYSTEM_ERROR,
                severity=ErrorSeverity.CRITICAL,
                recoverable=False,
                user_friendly_message="äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«å ±å‘Šã—ã¦ãã ã•ã„ã€‚",
                technical_details={
                    "traceback": traceback.format_exc(),
                    "error_args": getattr(error, 'args', [])
                },
                suggested_actions=["ç®¡ç†è€…ã«å ±å‘Š", "ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ"],
                context=context or {}
            )
```

### 2. ã‚¨ãƒ©ãƒ¼å¾©æ—§ã‚·ã‚¹ãƒ†ãƒ 

```python
class ErrorRecoveryManager:
    def __init__(self, bot):
        self.bot = bot
        self.recovery_strategies = {
            'commands.BotMissingPermissions': self._recover_missing_permissions,
            'discord.HTTPException': self._recover_http_exception,
            'commands.CommandOnCooldown': self._recover_cooldown,
            'ConnectionError': self._recover_connection_error
        }
    
    async def attempt_recovery(self, error_info: ErrorInfo, ctx: commands.Context) -> bool:
        """ã‚¨ãƒ©ãƒ¼å¾©æ—§ã®è©¦è¡Œ"""
        recovery_strategy = self.recovery_strategies.get(error_info.error_type)
        
        if recovery_strategy:
            try:
                return await recovery_strategy(error_info, ctx)
            except Exception as e:
                logger.error(f"Recovery attempt failed: {e}")
                return False
        
        return False
    
    async def _recover_missing_permissions(self, error_info: ErrorInfo, ctx: commands.Context) -> bool:
        """æ¨©é™ä¸è¶³ã‚¨ãƒ©ãƒ¼ã®å¾©æ—§"""
        missing_perms = error_info.technical_details.get('missing_permissions', [])
        
        # ç®¡ç†è€…ã«æ¨©é™ä»˜ä¸ã‚’è¦æ±‚
        admin_channel = self.bot.get_channel(self.bot.ERROR_LOG_CHANNEL_ID)
        if admin_channel:
            embed = discord.Embed(
                title="ğŸ”§ æ¨©é™ä¸è¶³ã‚¨ãƒ©ãƒ¼ - è‡ªå‹•å¾©æ—§è¦æ±‚",
                description=f"ãƒœãƒƒãƒˆã«ä»¥ä¸‹ã®æ¨©é™ãŒå¿…è¦ã§ã™ï¼š\n{', '.join(missing_perms)}",
                color=0xFF9900
            )
            embed.add_field(name="ã‚µãƒ¼ãƒãƒ¼", value=ctx.guild.name, inline=True)
            embed.add_field(name="ãƒãƒ£ãƒ³ãƒãƒ«", value=ctx.channel.mention, inline=True)
            embed.add_field(name="ã‚³ãƒãƒ³ãƒ‰", value=ctx.command.name, inline=True)
            
            await admin_channel.send(embed=embed)
        
        return False  # æ‰‹å‹•ä»‹å…¥ãŒå¿…è¦
    
    async def _recover_http_exception(self, error_info: ErrorInfo, ctx: commands.Context) -> bool:
        """HTTPä¾‹å¤–ã®å¾©æ—§"""
        status = error_info.technical_details.get('status')
        
        if status == 429:  # Rate Limited
            # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å ´åˆã¯å¾…æ©Ÿ
            await asyncio.sleep(5)
            return True
        elif status in [500, 502, 503, 504]:  # Server errors
            # ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯çŸ­æ™‚é–“å¾…æ©Ÿå¾Œã«å†è©¦è¡Œ
            await asyncio.sleep(2)
            return True
        
        return False
    
    async def _recover_cooldown(self, error_info: ErrorInfo, ctx: commands.Context) -> bool:
        """ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚¨ãƒ©ãƒ¼ã®å¾©æ—§"""
        # ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯è‡ªç„¶å›å¾©ã‚’å¾…ã¤
        return False
    
    async def _recover_connection_error(self, error_info: ErrorInfo, ctx: commands.Context) -> bool:
        """æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å¾©æ—§"""
        # æ¥ç¶šã®å†ç¢ºç«‹ã‚’è©¦è¡Œ
        try:
            if self.bot.is_closed():
                await self.bot.connect(reconnect=True)
                return True
        except Exception:
            pass
        
        return False
```

## ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

### 1. ç®¡ç†è€…é€šçŸ¥

```python
async def _notify_administrators(error_info: ErrorInfo, error_channel_id: int, ctx: commands.Context) -> None:
    """ç®¡ç†è€…ã¸ã®é€šçŸ¥"""
    try:
        channel = ctx.bot.get_channel(error_channel_id)
        if not channel:
            return
        
        embed = discord.Embed(
            title=f"ğŸš¨ {error_info.severity} ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ",
            description=error_info.error_message,
            color=_get_color_for_severity(error_info.severity),
            timestamp=datetime.now(pytz.timezone('Asia/Tokyo'))
        )
        
        embed.add_field(
            name="ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—",
            value=error_info.error_type,
            inline=True
        )
        
        embed.add_field(
            name="ã‚«ãƒ†ã‚´ãƒª",
            value=error_info.category.value,
            inline=True
        )
        
        embed.add_field(
            name="å¾©æ—§å¯èƒ½",
            value="âœ… ã¯ã„" if error_info.recoverable else "âŒ ã„ã„ãˆ",
            inline=True
        )
        
        if error_info.context:
            context_text = ""
            if "command" in error_info.context:
                context_text += f"ã‚³ãƒãƒ³ãƒ‰: {error_info.context['command']['name']}\n"
            if "user" in error_info.context:
                context_text += f"ãƒ¦ãƒ¼ã‚¶ãƒ¼: {error_info.context['user']['name']} ({error_info.context['user']['id']})\n"
            if "guild" in error_info.context:
                context_text += f"ã‚µãƒ¼ãƒãƒ¼: {error_info.context['guild']['name']} ({error_info.context['guild']['id']})\n"
            
            if context_text:
                embed.add_field(name="ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ", value=context_text, inline=False)
        
        if error_info.suggested_actions:
            actions_text = "\n".join([f"â€¢ {action}" for action in error_info.suggested_actions])
            embed.add_field(name="æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³", value=actions_text, inline=False)
        
        if error_info.technical_details:
            details_text = "```json\n" + json.dumps(error_info.technical_details, indent=2, ensure_ascii=False) + "\n```"
            if len(details_text) > 1024:
                details_text = details_text[:1020] + "...\n```"
            embed.add_field(name="æŠ€è¡“çš„è©³ç´°", value=details_text, inline=False)
        
        await channel.send(embed=embed)
        
    except Exception as e:
        logger.error(f"Failed to notify administrators: {e}")

def _get_color_for_severity(severity: ErrorSeverity) -> int:
    """é‡è¦åº¦ã«å¿œã˜ãŸè‰²ã‚’å–å¾—"""
    colors = {
        ErrorSeverity.LOW: 0x808080,      # ã‚°ãƒ¬ãƒ¼
        ErrorSeverity.MEDIUM: 0xFF9900,   # ã‚ªãƒ¬ãƒ³ã‚¸
        ErrorSeverity.HIGH: 0xFF0000,     # èµ¤
        ErrorSeverity.CRITICAL: 0x990000  # æš—èµ¤
    }
    return colors.get(severity, 0x000000)
```

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ

```python
async def _generate_user_message(error_info: ErrorInfo) -> Optional[str]:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ"""
    if error_info.category == ErrorCategory.USER_ERROR and error_info.severity == ErrorSeverity.LOW:
        return error_info.user_friendly_message
    elif error_info.category == ErrorCategory.PERMISSION_ERROR:
        return f"âŒ {error_info.user_friendly_message}"
    elif error_info.severity in [ErrorSeverity.HIGH, ErrorSeverity.CRITICAL]:
        return f"âš ï¸ {error_info.user_friendly_message}\n\nã‚¨ãƒ©ãƒ¼ID: {_generate_error_id()}"
    else:
        return error_info.user_friendly_message

def _generate_error_id() -> str:
    """ã‚¨ãƒ©ãƒ¼IDã®ç”Ÿæˆ"""
    import uuid
    return str(uuid.uuid4())[:8].upper()
```

## ãƒ­ã‚°è¨˜éŒ²

### 1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²

```python
async def _log_error(error_info: ErrorInfo, ctx: commands.Context) -> None:
    """ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è¨˜éŒ²"""
    log_data = {
        "timestamp": datetime.now(pytz.timezone('Asia/Tokyo')).isoformat(),
        "error_type": error_info.error_type,
        "error_message": error_info.error_message,
        "category": error_info.category.value,
        "severity": error_info.severity.value,
        "recoverable": error_info.recoverable,
        "context": error_info.context,
        "technical_details": error_info.technical_details,
        "suggested_actions": error_info.suggested_actions,
        "command_info": {
            "name": ctx.command.name if ctx.command else None,
            "cog": ctx.cog.__class__.__name__ if ctx.cog else None,
            "content": ctx.message.content
        },
        "user_info": {
            "id": ctx.author.id,
            "name": str(ctx.author),
            "bot": ctx.author.bot
        },
        "guild_info": {
            "id": ctx.guild.id,
            "name": ctx.guild.name,
            "member_count": ctx.guild.member_count
        } if ctx.guild else None,
        "channel_info": {
            "id": ctx.channel.id,
            "name": getattr(ctx.channel, 'name', 'DM'),
            "type": str(ctx.channel.type)
        }
    }
    
    logger.error(f"Command error occurred: {error_info.error_type}", extra={"error_data": log_data})

async def _log_interaction_error(error_info: ErrorInfo, interaction: discord.Interaction) -> None:
    """ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è¨˜éŒ²"""
    log_data = {
        "timestamp": datetime.now(pytz.timezone('Asia/Tokyo')).isoformat(),
        "error_type": error_info.error_type,
        "error_message": error_info.error_message,
        "category": error_info.category.value,
        "severity": error_info.severity.value,
        "context": error_info.context,
        "interaction_info": {
            "command_name": interaction.command.name if interaction.command else None,
            "command_type": "application_command",
            "user_id": interaction.user.id,
            "user_name": str(interaction.user),
            "guild_id": interaction.guild.id if interaction.guild else None,
            "guild_name": interaction.guild.name if interaction.guild else None,
            "channel_id": interaction.channel.id if interaction.channel else None
        }
    }
    
    logger.error(f"Application command error occurred: {error_info.error_type}", extra={"error_data": log_data})
```

## ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã¨ãƒ¬ãƒãƒ¼ãƒˆ

### 1. ã‚¨ãƒ©ãƒ¼çµ±è¨ˆåé›†

```python
class ErrorStatistics:
    def __init__(self, db_service):
        self.db_service = db_service
    
    async def record_error(self, error_info: ErrorInfo, context: Dict[str, Any]) -> None:
        """ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã®è¨˜éŒ²"""
        query = """
        INSERT INTO error_statistics (
            timestamp, error_type, category, severity, 
            recoverable, command_name, user_id, guild_id, 
            created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        """
        
        await self.db_service.execute_query(
            query,
            (
                datetime.now().isoformat(),
                error_info.error_type,
                error_info.category.value,
                error_info.severity.value,
                error_info.recoverable,
                context.get("command", {}).get("name"),
                context.get("user", {}).get("id"),
                context.get("guild", {}).get("id"),
                datetime.now().isoformat()
            )
        )
    
    async def get_error_trends(self, days: int = 7) -> Dict[str, Any]:
        """ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ³ãƒ‰ã®å–å¾—"""
        query = """
        SELECT 
            DATE(timestamp) as date,
            error_type,
            category,
            severity,
            COUNT(*) as count
        FROM error_statistics 
        WHERE timestamp > datetime('now', '-{} days')
        GROUP BY DATE(timestamp), error_type, category, severity
        ORDER BY date DESC, count DESC
        """.format(days)
        
        results = await self.db_service.fetch_all(query, ())
        
        trends = {
            "daily_counts": {},
            "error_types": {},
            "categories": {},
            "severities": {}
        }
        
        for row in results:
            date = row["date"]
            if date not in trends["daily_counts"]:
                trends["daily_counts"][date] = 0
            trends["daily_counts"][date] += row["count"]
            
            error_type = row["error_type"]
            if error_type not in trends["error_types"]:
                trends["error_types"][error_type] = 0
            trends["error_types"][error_type] += row["count"]
            
            category = row["category"]
            if category not in trends["categories"]:
                trends["categories"][category] = 0
            trends["categories"][category] += row["count"]
            
            severity = row["severity"]
            if severity not in trends["severities"]:
                trends["severities"][severity] = 0
            trends["severities"][severity] += row["count"]
        
        return trends
    
    async def get_top_error_sources(self, limit: int = 10) -> List[Dict[str, Any]]:
        """ä¸»è¦ã‚¨ãƒ©ãƒ¼æºã®å–å¾—"""
        query = """
        SELECT 
            command_name,
            error_type,
            COUNT(*) as error_count,
            MAX(timestamp) as last_occurrence
        FROM error_statistics 
        WHERE timestamp > datetime('now', '-7 days')
        GROUP BY command_name, error_type
        ORDER BY error_count DESC
        LIMIT ?
        """
        
        return await self.db_service.fetch_all(query, (limit,))
```

## Cogãƒ¬ãƒ™ãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 1. Cogã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```python
class ExampleCog(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.error_stats = ErrorStatistics(bot.db_service)
    
    @commands.command()
    async def example_command(self, ctx):
        try:
            # ã‚³ãƒãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯
            pass
        except SpecificException as e:
            # ç‰¹å®šã®ä¾‹å¤–ã®å‡¦ç†
            await self._handle_specific_error(ctx, e)
        except Exception as e:
            # äºˆæœŸã—ãªã„ä¾‹å¤–
            await self._handle_unexpected_error(ctx, e)
    
    async def _handle_specific_error(self, ctx: commands.Context, error: Exception) -> None:
        """ç‰¹å®šã‚¨ãƒ©ãƒ¼ã®å‡¦ç†"""
        error_info = ErrorInfo(
            error_type=type(error).__name__,
            error_message=str(error),
            category=ErrorCategory.USER_ERROR,
            severity=ErrorSeverity.LOW,
            recoverable=True,
            user_friendly_message="æ“ä½œã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
            technical_details={"error_details": str(error)},
            suggested_actions=["å…¥åŠ›ã‚’ç¢ºèª", "å†è©¦è¡Œ"],
            context={"command": ctx.command.name, "user": ctx.author.id}
        )
        
        await ctx.send(error_info.user_friendly_message)
        await self.error_stats.record_error(error_info, {"command": {"name": ctx.command.name}})
    
    async def _handle_unexpected_error(self, ctx: commands.Context, error: Exception) -> None:
        """äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†"""
        error_id = _generate_error_id()
        
        await ctx.send(f"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ID: {error_id}")
        
        # è©³ç´°ãƒ­ã‚°
        logger.error(
            f"Unexpected error in {ctx.command.name}",
            extra={
                "error_id": error_id,
                "error": str(error),
                "traceback": traceback.format_exc(),
                "command": ctx.command.name,
                "user": ctx.author.id,
                "guild": ctx.guild.id if ctx.guild else None
            }
        )
    
    @example_command.error
    async def example_command_error(self, ctx: commands.Context, error: commands.CommandError) -> None:
        """ã‚³ãƒãƒ³ãƒ‰å›ºæœ‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼"""
        if isinstance(error, commands.MissingRequiredArgument):
            await ctx.send(f"å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `{error.param.name}` ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚")
            ctx.handled = True
        elif isinstance(error, commands.BadArgument):
            await ctx.send("ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚")
            ctx.handled = True
        # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«å§”è­²
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

### 1. ã‚¨ãƒ©ãƒ¼ç‡ç›£è¦–

```python
class ErrorRateMonitor:
    def __init__(self, threshold: float = 0.05):
        self.threshold = threshold  # 5%
        self.error_count = 0
        self.total_count = 0
        self.window_start = time.time()
        self.window_duration = 300  # 5åˆ†
    
    def record_command(self, success: bool) -> None:
        """ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œçµæœã®è¨˜éŒ²"""
        current_time = time.time()
        
        # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚»ãƒƒãƒˆ
        if current_time - self.window_start > self.window_duration:
            self.error_count = 0
            self.total_count = 0
            self.window_start = current_time
        
        self.total_count += 1
        if not success:
            self.error_count += 1
    
    def get_error_rate(self) -> float:
        """ç¾åœ¨ã®ã‚¨ãƒ©ãƒ¼ç‡ã‚’å–å¾—"""
        if self.total_count == 0:
            return 0.0
        return self.error_count / self.total_count
    
    def is_error_rate_high(self) -> bool:
        """ã‚¨ãƒ©ãƒ¼ç‡ãŒé–¾å€¤ã‚’è¶…ãˆã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
        return self.get_error_rate() > self.threshold and self.total_count >= 10
```

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ¡ã‚¤ãƒ³ãƒœãƒƒãƒˆã‚¯ãƒ©ã‚¹](01-main-bot-class.md)
- [ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ](03-logging-system.md)
- [èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ](02-authentication-system.md)
- [ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ãƒ•ãƒ­ãƒ¼](../01-architecture/02-application-startup-flow.md)
