# ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰

## C.O.M.E.T.ã«ã¤ã„ã¦

**C.O.M.E.T.**ã®åå‰ã¯ä»¥ä¸‹ã®é ­æ–‡å­—ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

- **C**ommunity of
- **O**shilove
- **M**oderation &
- **E**njoyment
- **T**ogether

HFS - ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µãƒ¼ãƒãƒ¼ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ”¯ãˆã‚‹ã€æ¨ã—æ„›ã¨ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ãã—ã¦æ¥½ã—ã•ã‚’ä¸€ç·’ã«æä¾›ã™ã‚‹ãƒœãƒƒãƒˆã§ã™ã€‚

## æ¦‚è¦

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€COMETãƒœãƒƒãƒˆã®æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã‚’è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚Dockerã€GitHub Actionsã€æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€ç›£è¦–è¨­å®šãªã©ã€æ§˜ã€…ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ–¹æ³•ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é–‹ç™ºç’°å¢ƒ (Development)                                     â”‚
â”‚  â”œâ”€â”€ ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º                                            â”‚
â”‚  â”œâ”€â”€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ                                              â”‚
â”‚  â”œâ”€â”€ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯                                      â”‚
â”‚  â””â”€â”€ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (GitHub Actions)                        â”‚
â”‚  â”œâ”€â”€ è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ                                          â”‚
â”‚  â”œâ”€â”€ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯                                      â”‚
â”‚  â”œâ”€â”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³                                    â”‚
â”‚  â”œâ”€â”€ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰                                  â”‚
â”‚  â””â”€â”€ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ (Staging)                                 â”‚
â”‚  â”œâ”€â”€ æœ¬ç•ªç’°å¢ƒã¨åŒç­‰ã®è¨­å®š                                    â”‚
â”‚  â”œâ”€â”€ çµ±åˆãƒ†ã‚¹ãƒˆ                                              â”‚
â”‚  â”œâ”€â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ                                    â”‚
â”‚  â””â”€â”€ æœ€çµ‚æ¤œè¨¼                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœ¬ç•ªç’°å¢ƒ (Production)                                      â”‚
â”‚  â”œâ”€â”€ é«˜å¯ç”¨æ€§è¨­å®š                                            â”‚
â”‚  â”œâ”€â”€ ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ                                          â”‚
â”‚  â”œâ”€â”€ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§                                      â”‚
â”‚  â””â”€â”€ ãƒ­ã‚°ç®¡ç†                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å‰ææ¡ä»¶

### ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶

- **OS**: Ubuntu 20.04 LTS ä»¥ä¸Š / CentOS 8 ä»¥ä¸Š / Windows Server 2019 ä»¥ä¸Š
- **Python**: 3.8 ä»¥ä¸Š
- **ãƒ¡ãƒ¢ãƒª**: æœ€å° 512MBã€æ¨å¥¨ 1GB ä»¥ä¸Š
- **ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡**: æœ€å° 2GBã€æ¨å¥¨ 5GB ä»¥ä¸Š
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šï¼ˆDiscord API ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼‰

### å¿…è¦ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢

- Git
- Python 3.8+
- pip
- Dockerï¼ˆDockerãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆï¼‰
- systemdï¼ˆLinuxã‚µãƒ¼ãƒ“ã‚¹åŒ–ã®å ´åˆï¼‰

## ç’°å¢ƒè¨­å®š

### 1. ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# .env.production
# Discord Bot Configuration
BOT_TOKEN=your_production_bot_token_here
COMMAND_PREFIX=!

# Guild and Channel IDs
ADMIN_MAIN_GUILD_ID=123456789012345678
ADMIN_DEV_GUILD_ID=876543210987654321
ADMIN_STARTUP_CHANNEL_ID=111111111111111111
ADMIN_BUG_REPORT_CHANNEL_ID=222222222222222222
ADMIN_ERROR_LOG_CHANNEL_ID=333333333333333333

# Authentication
AUTH_TOKEN=your_production_auth_token_here
AUTH_URL=https://your-production-auth-endpoint.com/api

# External Services
SENTRY_DSN=your_production_sentry_dsn_here
WEBHOOK_URL=your_production_webhook_url_here

# Feature Flags
ENABLE_ANALYTICS=true
ENABLE_MONITORING=true
DEBUG_MODE=false

# Database Configuration
DATABASE_URL=sqlite:///config/bot.db
DATABASE_POOL_SIZE=10

# Monitoring
PROMETHEUS_ENABLED=true
PROMETHEUS_PORT=8001
UPTIME_KUMA_URL=your_production_uptime_kuma_url

# Production Settings
ENVIRONMENT=production
LOG_LEVEL=INFO
```

### 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™

```json
// config/bot.production.json
{
    "bot_info": {
        "name": "COMET",
        "version": "2.1.0",
        "description": "HFSå°‚å±BOT ç·åˆã‚¬ã‚¤ãƒ‰",
        "author": "FreeWiFiTech",
        "support_server": "https://discord.gg/hfs"
    },
    "features": {
        "moderation": {
            "enabled": true,
            "auto_mod": true,
            "log_actions": true
        },
        "entertainment": {
            "enabled": true,
            "omikuji": true,
            "giveaway": true
        },
        "analytics": {
            "enabled": true,
            "user_tracking": true,
            "server_stats": true
        }
    },
    "limits": {
        "max_warnings": 3,
        "cooldown_duration": 300,
        "max_giveaway_entries": 1000
    },
    "production": {
        "auto_restart": true,
        "health_check_interval": 300,
        "backup_interval": 86400,
        "log_retention_days": 30
    }
}
```

## Dockerãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### 1. Dockerfile ã®æœ€é©åŒ–

```dockerfile
# Dockerfile.production
FROM python:3.10.16-slim-bookworm

# ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡åŒ–ï¼‰
COPY requirements.txt .

# Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
COPY . .

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
RUN useradd --create-home --shell /bin/bash comet && \
    chown -R comet:comet /app
USER comet

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8001/health')" || exit 1

# ãƒãƒ¼ãƒˆã®å…¬é–‹
EXPOSE 8001

# èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
CMD ["python", "main.py"]
```

### 2. Docker Composeè¨­å®š

```yaml
# docker-compose.production.yml
version: '3.8'

services:
  comet-bot:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: comet-bot-prod
    restart: unless-stopped
    environment:
      - ENVIRONMENT=production
    env_file:
      - .env.production
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      - ./data:/app/data
    ports:
      - "8001:8001"
    networks:
      - comet-network
    depends_on:
      - prometheus
      - grafana
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  prometheus:
    image: prom/prometheus:latest
    container_name: comet-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - comet-network

  grafana:
    image: grafana/grafana:latest
    container_name: comet-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - comet-network

networks:
  comet-network:
    driver: bridge

volumes:
  prometheus_data:
  grafana_data:
```

### 3. ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

echo "ğŸš€ Starting COMET Bot deployment..."

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
if [ ! -f ".env.production" ]; then
    echo "âŒ .env.production file not found"
    exit 1
fi

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
if [ ! -f "config/bot.production.json" ]; then
    echo "âŒ Production configuration file not found"
    exit 1
fi

# æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢
echo "ğŸ›‘ Stopping existing containers..."
docker-compose -f docker-compose.production.yml down

# æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
echo "ğŸ“¥ Pulling latest code..."
git pull origin main

# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
echo "ğŸ”¨ Building Docker image..."
docker-compose -f docker-compose.production.yml build --no-cache

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
echo "ğŸ’¾ Creating database backup..."
if [ -f "config/bot.db" ]; then
    cp config/bot.db "config/bot.db.backup.$(date +%Y%m%d_%H%M%S)"
fi

# ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•
echo "â–¶ï¸ Starting containers..."
docker-compose -f docker-compose.production.yml up -d

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ¥ Performing health check..."
sleep 30

if curl -f http://localhost:8001/health > /dev/null 2>&1; then
    echo "âœ… Deployment successful! Bot is healthy."
else
    echo "âŒ Health check failed. Rolling back..."
    docker-compose -f docker-compose.production.yml down
    exit 1
fi

echo "ğŸ‰ Deployment completed successfully!"
```

## GitHub Actions CI/CD

### 1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®š

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio
    
    - name: Run tests
      run: |
        python -m pytest tests/ --cov=cogs --cov=utils --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'

  build-and-deploy:
    needs: [test, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile.production
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PRIVATE_KEY_PASS }}
        script: |
          cd ${{ secrets.SERVER_DEPLOY_DIR }}
          
          # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
          echo "${{ secrets.ENV_PRODUCTION }}" > .env.production
          
          # æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          git pull origin main
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
          chmod +x scripts/deploy.sh
          ./scripts/deploy.sh
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          docker system prune -f
    
    - name: Notify deployment status
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
```

### 2. ç’°å¢ƒå›ºæœ‰ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```yaml
# .github/workflows/staging-deploy.yml
name: Deploy to Staging

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to staging environment
      run: |
        echo "Deploying to staging..."
        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
    
    - name: Run integration tests
      run: |
        echo "Running integration tests..."
        # çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
    
    - name: Comment PR with staging URL
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸš€ Staging deployment completed! Test at: https://staging.comet-bot.example.com'
          })
```

## æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### 1. ã‚µãƒ¼ãƒãƒ¼æº–å‚™

```bash
# ã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
#!/bin/bash
# scripts/server-setup.sh

echo "ğŸ”§ Setting up COMET Bot server..."

# ã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°
sudo apt update && sudo apt upgrade -y

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    curl \
    wget \
    unzip \
    systemd \
    nginx \
    certbot \
    python3-certbot-nginx

# Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Docker Composeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
sudo useradd -m -s /bin/bash comet
sudo mkdir -p /opt/comet-bot
sudo chown comet:comet /opt/comet-bot

echo "âœ… Server setup completed!"
```

### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
#!/bin/bash
# scripts/manual-deploy.sh

set -e

DEPLOY_DIR="/opt/comet-bot"
SERVICE_NAME="comet-bot"
BACKUP_DIR="/opt/comet-bot/backups"

echo "ğŸš€ Starting manual deployment..."

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
sudo mkdir -p $BACKUP_DIR

# æ—¢å­˜ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
if systemctl is-active --quiet $SERVICE_NAME; then
    echo "ğŸ›‘ Stopping existing service..."
    sudo systemctl stop $SERVICE_NAME
fi

# ç¾åœ¨ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
if [ -d "$DEPLOY_DIR/current" ]; then
    echo "ğŸ’¾ Creating backup..."
    sudo cp -r $DEPLOY_DIR/current $BACKUP_DIR/backup-$(date +%Y%m%d_%H%M%S)
fi

# æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
sudo mkdir -p $DEPLOY_DIR/releases/$(date +%Y%m%d_%H%M%S)
RELEASE_DIR=$DEPLOY_DIR/releases/$(date +%Y%m%d_%H%M%S)

# ã‚³ãƒ¼ãƒ‰ã®ã‚¯ãƒ­ãƒ¼ãƒ³
echo "ğŸ“¥ Cloning repository..."
sudo git clone https://github.com/HolofanServer/comet.git $RELEASE_DIR
cd $RELEASE_DIR

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ğŸ“¦ Installing dependencies..."
sudo python3 -m venv venv
sudo $RELEASE_DIR/venv/bin/pip install --upgrade pip
sudo $RELEASE_DIR/venv/bin/pip install -r requirements.txt

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
echo "âš™ï¸ Copying configuration..."
sudo cp /opt/comet-bot/config/.env.production $RELEASE_DIR/.env
sudo cp -r /opt/comet-bot/config $RELEASE_DIR/

# æ¨©é™ã®è¨­å®š
sudo chown -R comet:comet $RELEASE_DIR

# ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®æ›´æ–°
sudo rm -f $DEPLOY_DIR/current
sudo ln -s $RELEASE_DIR $DEPLOY_DIR/current

# ã‚µãƒ¼ãƒ“ã‚¹ã®é–‹å§‹
echo "â–¶ï¸ Starting service..."
sudo systemctl start $SERVICE_NAME
sudo systemctl enable $SERVICE_NAME

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ¥ Performing health check..."
sleep 30

if curl -f http://localhost:8001/health > /dev/null 2>&1; then
    echo "âœ… Deployment successful!"
    
    # å¤ã„ãƒªãƒªãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæœ€æ–°5ã¤ã‚’ä¿æŒï¼‰
    cd $DEPLOY_DIR/releases
    sudo ls -t | tail -n +6 | xargs -r rm -rf
else
    echo "âŒ Health check failed. Rolling back..."
    
    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if [ -d "$BACKUP_DIR" ]; then
        LATEST_BACKUP=$(ls -t $BACKUP_DIR | head -n 1)
        sudo rm -f $DEPLOY_DIR/current
        sudo ln -s $BACKUP_DIR/$LATEST_BACKUP $DEPLOY_DIR/current
        sudo systemctl start $SERVICE_NAME
    fi
    
    exit 1
fi

echo "ğŸ‰ Manual deployment completed!"
```

### 3. systemd ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š

```ini
# /etc/systemd/system/comet-bot.service
[Unit]
Description=COMET Discord Bot
After=network.target
Wants=network.target

[Service]
Type=simple
User=comet
Group=comet
WorkingDirectory=/opt/comet-bot/current
Environment=PATH=/opt/comet-bot/current/venv/bin
ExecStart=/opt/comet-bot/current/venv/bin/python main.py
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=comet-bot

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/comet-bot/current/logs /opt/comet-bot/current/config

[Install]
WantedBy=multi-user.target
```

## ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

### 1. Prometheusè¨­å®š

```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'comet-bot'
    static_configs:
      - targets: ['comet-bot:8001']
    metrics_path: /metrics
    scrape_interval: 30s

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
```

### 2. ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ«

```yaml
# monitoring/alert_rules.yml
groups:
  - name: comet-bot-alerts
    rules:
      - alert: BotDown
        expr: up{job="comet-bot"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "COMET Bot is down"
          description: "COMET Bot has been down for more than 1 minute."

      - alert: HighErrorRate
        expr: rate(comet_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second."

      - alert: HighMemoryUsage
        expr: comet_memory_usage_bytes / comet_memory_limit_bytes > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 80%."

      - alert: DatabaseConnectionFailed
        expr: comet_database_connection_status == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database connection failed"
          description: "Cannot connect to the database."
```

### 3. Grafanaãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```json
{
  "dashboard": {
    "title": "COMET Bot Monitoring",
    "panels": [
      {
        "title": "Bot Status",
        "type": "stat",
        "targets": [
          {
            "expr": "up{job=\"comet-bot\"}",
            "legendFormat": "Bot Status"
          }
        ]
      },
      {
        "title": "Commands per Second",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(comet_commands_total[1m])",
            "legendFormat": "Commands/sec"
          }
        ]
      },
      {
        "title": "Error Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(comet_errors_total[1m])",
            "legendFormat": "Errors/sec"
          }
        ]
      },
      {
        "title": "Memory Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "comet_memory_usage_bytes",
            "legendFormat": "Memory Usage"
          }
        ]
      }
    ]
  }
}
```

## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©æ—§

### 1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="/opt/comet-bot/backups"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

echo "ğŸ’¾ Starting backup process..."

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
mkdir -p $BACKUP_DIR

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
if [ -f "/opt/comet-bot/current/config/bot.db" ]; then
    echo "ğŸ“Š Backing up database..."
    cp /opt/comet-bot/current/config/bot.db $BACKUP_DIR/bot_db_$DATE.db
fi

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
echo "âš™ï¸ Backing up configuration..."
tar -czf $BACKUP_DIR/config_$DATE.tar.gz -C /opt/comet-bot/current config/

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
if [ -d "/opt/comet-bot/current/logs" ]; then
    echo "ğŸ“ Backing up logs..."
    tar -czf $BACKUP_DIR/logs_$DATE.tar.gz -C /opt/comet-bot/current logs/
fi

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤
echo "ğŸ§¹ Cleaning up old backups..."
find $BACKUP_DIR -name "*.db" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "âœ… Backup completed: $DATE"
```

### 2. å¾©æ—§ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# scripts/restore.sh

BACKUP_DIR="/opt/comet-bot/backups"
DEPLOY_DIR="/opt/comet-bot/current"

if [ -z "$1" ]; then
    echo "Usage: $0 <backup_date>"
    echo "Available backups:"
    ls -la $BACKUP_DIR | grep -E "(bot_db_|config_|logs_)"
    exit 1
fi

BACKUP_DATE=$1

echo "ğŸ”„ Starting restore process for backup: $BACKUP_DATE"

# ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢
echo "ğŸ›‘ Stopping service..."
sudo systemctl stop comet-bot

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¾©æ—§
if [ -f "$BACKUP_DIR/bot_db_$BACKUP_DATE.db" ]; then
    echo "ğŸ“Š Restoring database..."
    sudo cp $BACKUP_DIR/bot_db_$BACKUP_DATE.db $DEPLOY_DIR/config/bot.db
    sudo chown comet:comet $DEPLOY_DIR/config/bot.db
fi

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©æ—§
if [ -f "$BACKUP_DIR/config_$BACKUP_DATE.tar.gz" ]; then
    echo "âš™ï¸ Restoring configuration..."
    sudo tar -xzf $BACKUP_DIR/config_$BACKUP_DATE.tar.gz -C $DEPLOY_DIR
    sudo chown -R comet:comet $DEPLOY_DIR/config
fi

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©æ—§
if [ -f "$BACKUP_DIR/logs_$BACKUP_DATE.tar.gz" ]; then
    echo "ğŸ“ Restoring logs..."
    sudo tar -xzf $BACKUP_DIR/logs_$BACKUP_DATE.tar.gz -C $DEPLOY_DIR
    sudo chown -R comet:comet $DEPLOY_DIR/logs
fi

# ã‚µãƒ¼ãƒ“ã‚¹ã®é–‹å§‹
echo "â–¶ï¸ Starting service..."
sudo systemctl start comet-bot

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ¥ Performing health check..."
sleep 30

if curl -f http://localhost:8001/health > /dev/null 2>&1; then
    echo "âœ… Restore completed successfully!"
else
    echo "âŒ Health check failed after restore."
    exit 1
fi
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. ä¸€èˆ¬çš„ãªå•é¡Œã¨è§£æ±ºæ–¹æ³•

#### ãƒœãƒƒãƒˆãŒèµ·å‹•ã—ãªã„

```bash
# ãƒ­ã‚°ã®ç¢ºèª
sudo journalctl -u comet-bot -f

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
python3 -c "
import json
with open('config/bot.json') as f:
    config = json.load(f)
    print('Configuration loaded successfully')
"

# ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
pip list | grep discord
```

#### ãƒ¡ãƒ¢ãƒªä¸è¶³

```bash
# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ç¢ºèª
free -h
ps aux | grep python

# ã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
ls -la config/bot.db
sqlite3 config/bot.db ".tables"

# æ¨©é™ã®ç¢ºèª
sudo chown comet:comet config/bot.db
sudo chmod 644 config/bot.db
```

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

```bash
# ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®ç›£è¦–
htop
iotop
nethogs

# Pythonãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°
python3 -m cProfile -o profile.stats main.py

# ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®èª¿æ•´
export LOG_LEVEL=WARNING
```

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](01-development-setup.md)
- [ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯](02-testing-framework.md)
- [è²¢çŒ®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](04-contributing-guidelines.md)
- [ç›£è¦–Cogs](../03-cogs/08-monitoring-cogs.md)
