# ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†

## C.O.M.E.T.ã«ã¤ã„ã¦

**C.O.M.E.T.**ã®åå‰ã¯ä»¥ä¸‹ã®é ­æ–‡å­—ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

- **C**ommunity of
- **O**shilove
- **M**oderation &
- **E**njoyment
- **T**ogether

HFS - ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µãƒ¼ãƒãƒ¼ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ”¯ãˆã‚‹ã€æ¨ã—æ„›ã¨ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ãã—ã¦æ¥½ã—ã•ã‚’ä¸€ç·’ã«æä¾›ã™ã‚‹ãƒœãƒƒãƒˆã§ã™ã€‚

## æ¦‚è¦

COMETãƒœãƒƒãƒˆã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ãƒœãƒƒãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’å‹•çš„ã«ç®¡ç†ã—ã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®åæ˜ ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†æ©Ÿèƒ½ã‚’æä¾›ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒœãƒƒãƒˆã®çŠ¶æ…‹ã‚’åˆ†ã‹ã‚Šã‚„ã™ãä¼ãˆã¾ã™ã€‚

## ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹åˆ¶å¾¡å±¤ (Presence Control)                        â”‚
â”‚  â”œâ”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†                                          â”‚
â”‚  â”œâ”€â”€ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç®¡ç†                                      â”‚
â”‚  â”œâ”€â”€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼                                          â”‚
â”‚  â””â”€â”€ å‹•çš„æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çŠ¶æ…‹ç›£è¦–å±¤ (State Monitoring)                              â”‚
â”‚  â”œâ”€â”€ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç›£è¦–                                        â”‚
â”‚  â”œâ”€â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–                                      â”‚
â”‚  â”œâ”€â”€ ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹æ¤œå‡º                                          â”‚
â”‚  â””â”€â”€ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†å±¤ (Message Management)                      â”‚
â”‚  â”œâ”€â”€ å®šå‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                                          â”‚
â”‚  â”œâ”€â”€ ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                                      â”‚
â”‚  â”œâ”€â”€ å¤šè¨€èªå¯¾å¿œ                                              â”‚
â”‚  â””â”€â”€ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¡¨ç¤ºå±¤ (Display Layer)                                     â”‚
â”‚  â”œâ”€â”€ Discord ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹                                     â”‚
â”‚  â”œâ”€â”€ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£è¡¨ç¤º                                      â”‚
â”‚  â”œâ”€â”€ ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹                                      â”‚
â”‚  â””â”€â”€ ãƒªãƒƒãƒãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

### 1. åŸºæœ¬ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†

```python
import discord
import asyncio
import random
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Union
from enum import Enum
import logging

logger = logging.getLogger(__name__)

class PresenceType(Enum):
    PLAYING = discord.ActivityType.playing
    STREAMING = discord.ActivityType.streaming
    LISTENING = discord.ActivityType.listening
    WATCHING = discord.ActivityType.watching
    CUSTOM = discord.ActivityType.custom
    COMPETING = discord.ActivityType.competing

class PresenceStatus(Enum):
    ONLINE = discord.Status.online
    IDLE = discord.Status.idle
    DND = discord.Status.dnd
    INVISIBLE = discord.Status.invisible

class PresenceManager:
    def __init__(self, bot):
        self.bot = bot
        self.current_presence = None
        self.presence_queue = []
        self.auto_rotation_enabled = True
        self.rotation_interval = 300  # 5åˆ†
        self.last_update = None
        
        # ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        self.presence_templates = {
            "default": [
                {"type": PresenceType.WATCHING, "name": "HFS ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£", "status": PresenceStatus.ONLINE},
                {"type": PresenceType.LISTENING, "name": "ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–éŸ³æ¥½", "status": PresenceStatus.ONLINE},
                {"type": PresenceType.PLAYING, "name": "æ¨ã—æ´»ã‚µãƒãƒ¼ãƒˆ", "status": PresenceStatus.ONLINE},
                {"type": PresenceType.WATCHING, "name": "é…ä¿¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–", "status": PresenceStatus.ONLINE},
            ],
            "maintenance": [
                {"type": PresenceType.PLAYING, "name": "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­...", "status": PresenceStatus.DND},
                {"type": PresenceType.WATCHING, "name": "ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°", "status": PresenceStatus.DND},
            ],
            "error": [
                {"type": PresenceType.PLAYING, "name": "ã‚¨ãƒ©ãƒ¼å¾©æ—§ä¸­", "status": PresenceStatus.IDLE},
                {"type": PresenceType.WATCHING, "name": "ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­", "status": PresenceStatus.IDLE},
            ],
            "celebration": [
                {"type": PresenceType.PLAYING, "name": "ğŸ‰ è¨˜å¿µæ—¥", "status": PresenceStatus.ONLINE},
                {"type": PresenceType.WATCHING, "name": "ğŸŠ ç‰¹åˆ¥é…ä¿¡", "status": PresenceStatus.ONLINE},
            ]
        }
        
        # å‹•çš„ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æƒ…å ±
        self.dynamic_info = {
            "guild_count": 0,
            "user_count": 0,
            "uptime": None,
            "version": "2.1.0"
        }
        
        # ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°ã‚¿ã‚¹ã‚¯
        self.presence_task = None
    
    async def start_presence_management(self):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†ã®é–‹å§‹"""
        if self.presence_task is None or self.presence_task.done():
            self.presence_task = self.bot.loop.create_task(self.presence_update_loop())
            logger.info("Presence management started")
    
    async def stop_presence_management(self):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†ã®åœæ­¢"""
        if self.presence_task and not self.presence_task.done():
            self.presence_task.cancel()
            logger.info("Presence management stopped")
    
    async def presence_update_loop(self):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°ãƒ«ãƒ¼ãƒ—"""
        await self.bot.wait_until_ready()
        
        while not self.bot.is_closed():
            try:
                if self.auto_rotation_enabled:
                    await self.rotate_presence()
                
                await asyncio.sleep(self.rotation_interval)
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"Presence update loop error: {e}")
                await asyncio.sleep(60)
    
    async def rotate_presence(self):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³"""
        try:
            # ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ
            template_name = self.get_current_template()
            templates = self.presence_templates.get(template_name, self.presence_templates["default"])
            
            # ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã‚’é¸æŠ
            presence_config = random.choice(templates)
            
            # å‹•çš„æƒ…å ±ã‚’å«ã‚€ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã‚’ç”Ÿæˆ
            dynamic_presence = await self.generate_dynamic_presence(presence_config)
            
            await self.set_presence(dynamic_presence)
            
        except Exception as e:
            logger.error(f"Failed to rotate presence: {e}")
    
    def get_current_template(self) -> str:
        """ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ±ºå®š"""
        # ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®ç¢ºèª
        if self.is_maintenance_mode():
            return "maintenance"
        elif self.has_critical_errors():
            return "error"
        elif self.is_special_event():
            return "celebration"
        else:
            return "default"
    
    def is_maintenance_mode(self) -> bool:
        """ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’ç¢ºèª"""
        # å®Ÿè£…ã¯å…·ä½“çš„ãªæ¡ä»¶ã«ä¾å­˜
        return False
    
    def has_critical_errors(self) -> bool:
        """é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèª"""
        # ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æº
        return False
    
    def is_special_event(self) -> bool:
        """ç‰¹åˆ¥ãªã‚¤ãƒ™ãƒ³ãƒˆæœŸé–“ã‹ã©ã†ã‹ã‚’ç¢ºèª"""
        # è¨˜å¿µæ—¥ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã®ç¢ºèª
        now = datetime.now()
        # ä¾‹: ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–è¨˜å¿µæ—¥ãªã©
        return False
    
    async def generate_dynamic_presence(self, base_config: Dict) -> Dict:
        """å‹•çš„æƒ…å ±ã‚’å«ã‚€ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®ç”Ÿæˆ"""
        # å‹•çš„æƒ…å ±ã®æ›´æ–°
        await self.update_dynamic_info()
        
        presence_name = base_config["name"]
        
        # å‹•çš„ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ç½®æ›
        presence_name = presence_name.replace("{guild_count}", str(self.dynamic_info["guild_count"]))
        presence_name = presence_name.replace("{user_count}", str(self.dynamic_info["user_count"]))
        presence_name = presence_name.replace("{version}", self.dynamic_info["version"])
        
        # ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã®è¡¨ç¤º
        if "{uptime}" in presence_name and self.dynamic_info["uptime"]:
            uptime_str = self.format_uptime(self.dynamic_info["uptime"])
            presence_name = presence_name.replace("{uptime}", uptime_str)
        
        return {
            "type": base_config["type"],
            "name": presence_name,
            "status": base_config["status"]
        }
    
    async def update_dynamic_info(self):
        """å‹•çš„æƒ…å ±ã®æ›´æ–°"""
        try:
            self.dynamic_info["guild_count"] = len(self.bot.guilds)
            self.dynamic_info["user_count"] = sum(guild.member_count for guild in self.bot.guilds)
            
            # ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã®è¨ˆç®—
            if hasattr(self.bot, 'start_time'):
                self.dynamic_info["uptime"] = datetime.now() - self.bot.start_time
                
        except Exception as e:
            logger.error(f"Failed to update dynamic info: {e}")
    
    def format_uptime(self, uptime: timedelta) -> str:
        """ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
        days = uptime.days
        hours, remainder = divmod(uptime.seconds, 3600)
        minutes, _ = divmod(remainder, 60)
        
        if days > 0:
            return f"{days}d {hours}h"
        elif hours > 0:
            return f"{hours}h {minutes}m"
        else:
            return f"{minutes}m"
    
    async def set_presence(self, presence_config: Dict):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®è¨­å®š"""
        try:
            activity_type = presence_config["type"].value
            activity_name = presence_config["name"]
            status = presence_config["status"].value
            
            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®ä½œæˆ
            if activity_type == discord.ActivityType.streaming:
                activity = discord.Streaming(
                    name=activity_name,
                    url="https://www.youtube.com/watch?v=dQw4w9WgXcQ"  # ãƒ€ãƒŸãƒ¼URL
                )
            else:
                activity = discord.Activity(
                    type=activity_type,
                    name=activity_name
                )
            
            # ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®æ›´æ–°
            await self.bot.change_presence(status=status, activity=activity)
            
            self.current_presence = presence_config
            self.last_update = datetime.now()
            
            logger.debug(f"Presence updated: {activity_name} ({status.name})")
            
        except Exception as e:
            logger.error(f"Failed to set presence: {e}")
    
    async def set_custom_presence(self, activity_type: PresenceType, name: str, status: PresenceStatus = PresenceStatus.ONLINE, duration: int = None):
        """ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®è¨­å®š"""
        presence_config = {
            "type": activity_type,
            "name": name,
            "status": status
        }
        
        await self.set_presence(presence_config)
        
        # ä¸€æ™‚çš„ãªãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®å ´åˆã€æŒ‡å®šæ™‚é–“å¾Œã«å…ƒã«æˆ»ã™
        if duration:
            await asyncio.sleep(duration)
            await self.rotate_presence()
    
    def add_custom_template(self, template_name: str, presences: List[Dict]):
        """ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¿½åŠ """
        self.presence_templates[template_name] = presences
        logger.info(f"Added custom presence template: {template_name}")
    
    def remove_template(self, template_name: str):
        """ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å‰Šé™¤"""
        if template_name in self.presence_templates and template_name != "default":
            del self.presence_templates[template_name]
            logger.info(f"Removed presence template: {template_name}")
    
    def set_rotation_interval(self, seconds: int):
        """ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é–“éš”ã®è¨­å®š"""
        self.rotation_interval = max(60, seconds)  # æœ€å°1åˆ†
        logger.info(f"Presence rotation interval set to {self.rotation_interval} seconds")
    
    def enable_auto_rotation(self):
        """è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹åŒ–"""
        self.auto_rotation_enabled = True
        logger.info("Auto presence rotation enabled")
    
    def disable_auto_rotation(self):
        """è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ç„¡åŠ¹åŒ–"""
        self.auto_rotation_enabled = False
        logger.info("Auto presence rotation disabled")
    
    def get_current_presence_info(self) -> Dict:
        """ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æƒ…å ±ã‚’å–å¾—"""
        return {
            "current_presence": self.current_presence,
            "last_update": self.last_update,
            "auto_rotation": self.auto_rotation_enabled,
            "rotation_interval": self.rotation_interval,
            "dynamic_info": self.dynamic_info
        }
```

### 2. ã‚¤ãƒ™ãƒ³ãƒˆé€£å‹•ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹

```python
class EventDrivenPresence:
    def __init__(self, presence_manager: PresenceManager):
        self.presence_manager = presence_manager
        self.event_handlers = {}
        self.temporary_presences = {}
    
    def register_event_handler(self, event_name: str, handler: callable):
        """ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ç™»éŒ²"""
        if event_name not in self.event_handlers:
            self.event_handlers[event_name] = []
        self.event_handlers[event_name].append(handler)
    
    async def handle_event(self, event_name: str, event_data: Dict = None):
        """ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†"""
        if event_name in self.event_handlers:
            for handler in self.event_handlers[event_name]:
                try:
                    await handler(event_data or {})
                except Exception as e:
                    logger.error(f"Event handler error for {event_name}: {e}")
    
    async def on_command_executed(self, event_data: Dict):
        """ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°"""
        command_name = event_data.get("command_name")
        user_count = event_data.get("user_count", 0)
        
        if command_name:
            temp_presence = {
                "type": PresenceType.PLAYING,
                "name": f"/{command_name} ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œä¸­",
                "status": PresenceStatus.ONLINE
            }
            
            await self.presence_manager.set_custom_presence(
                temp_presence["type"],
                temp_presence["name"],
                temp_presence["status"],
                duration=30  # 30ç§’é–“è¡¨ç¤º
            )
    
    async def on_error_occurred(self, event_data: Dict):
        """ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°"""
        error_severity = event_data.get("severity", "LOW")
        
        if error_severity in ["HIGH", "CRITICAL"]:
            error_presence = {
                "type": PresenceType.PLAYING,
                "name": "âš ï¸ ã‚·ã‚¹ãƒ†ãƒ å•é¡Œã‚’èª¿æŸ»ä¸­",
                "status": PresenceStatus.IDLE
            }
            
            await self.presence_manager.set_custom_presence(
                error_presence["type"],
                error_presence["name"],
                error_presence["status"],
                duration=600  # 10åˆ†é–“è¡¨ç¤º
            )
    
    async def on_maintenance_start(self, event_data: Dict):
        """ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é–‹å§‹æ™‚ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°"""
        maintenance_presence = {
            "type": PresenceType.PLAYING,
            "name": "ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­",
            "status": PresenceStatus.DND
        }
        
        # ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
        self.presence_manager.disable_auto_rotation()
        
        await self.presence_manager.set_custom_presence(
            maintenance_presence["type"],
            maintenance_presence["name"],
            maintenance_presence["status"]
        )
    
    async def on_maintenance_end(self, event_data: Dict):
        """ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çµ‚äº†æ™‚ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°"""
        # è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é–‹
        self.presence_manager.enable_auto_rotation()
        
        completion_presence = {
            "type": PresenceType.PLAYING,
            "name": "âœ… ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Œäº†",
            "status": PresenceStatus.ONLINE
        }
        
        await self.presence_manager.set_custom_presence(
            completion_presence["type"],
            completion_presence["name"],
            completion_presence["status"],
            duration=120  # 2åˆ†é–“è¡¨ç¤º
        )
    
    async def on_special_event(self, event_data: Dict):
        """ç‰¹åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ›´æ–°"""
        event_name = event_data.get("event_name", "ç‰¹åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆ")
        event_emoji = event_data.get("emoji", "ğŸ‰")
        
        event_presence = {
            "type": PresenceType.PLAYING,
            "name": f"{event_emoji} {event_name}",
            "status": PresenceStatus.ONLINE
        }
        
        await self.presence_manager.set_custom_presence(
            event_presence["type"],
            event_presence["name"],
            event_presence["status"],
            duration=3600  # 1æ™‚é–“è¡¨ç¤º
        )
```

### 3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†

```python
from datetime import time
import calendar

class PresenceScheduler:
    def __init__(self, presence_manager: PresenceManager):
        self.presence_manager = presence_manager
        self.schedules = {}
        self.timezone = "Asia/Tokyo"
    
    def add_schedule(self, schedule_name: str, schedule_config: Dict):
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¿½åŠ """
        self.schedules[schedule_name] = schedule_config
        logger.info(f"Added presence schedule: {schedule_name}")
    
    def remove_schedule(self, schedule_name: str):
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‰Šé™¤"""
        if schedule_name in self.schedules:
            del self.schedules[schedule_name]
            logger.info(f"Removed presence schedule: {schedule_name}")
    
    async def check_schedules(self):
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯"""
        import pytz
        
        now = datetime.now(pytz.timezone(self.timezone))
        current_time = now.time()
        current_weekday = now.weekday()
        
        for schedule_name, config in self.schedules.items():
            if self.should_activate_schedule(config, current_time, current_weekday):
                await self.activate_schedule(schedule_name, config)
    
    def should_activate_schedule(self, config: Dict, current_time: time, current_weekday: int) -> bool:
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–ã™ã¹ãã‹ãƒã‚§ãƒƒã‚¯"""
        # æ™‚é–“ãƒã‚§ãƒƒã‚¯
        start_time = config.get("start_time")
        end_time = config.get("end_time")
        
        if start_time and end_time:
            if not (start_time <= current_time <= end_time):
                return False
        
        # æ›œæ—¥ãƒã‚§ãƒƒã‚¯
        weekdays = config.get("weekdays")
        if weekdays and current_weekday not in weekdays:
            return False
        
        # æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
        specific_dates = config.get("specific_dates")
        if specific_dates:
            current_date = datetime.now().date()
            if current_date not in specific_dates:
                return False
        
        return True
    
    async def activate_schedule(self, schedule_name: str, config: Dict):
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æœ‰åŠ¹åŒ–"""
        presence_config = config.get("presence")
        if presence_config:
            await self.presence_manager.set_custom_presence(
                presence_config["type"],
                presence_config["name"],
                presence_config["status"],
                duration=config.get("duration")
            )
            
            logger.info(f"Activated scheduled presence: {schedule_name}")

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šä¾‹
def setup_default_schedules(scheduler: PresenceScheduler):
    """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨­å®š"""
    
    # å¹³æ—¥ã®æœã®æŒ¨æ‹¶
    scheduler.add_schedule("morning_greeting", {
        "start_time": time(8, 0),
        "end_time": time(9, 0),
        "weekdays": [0, 1, 2, 3, 4],  # æœˆ-é‡‘
        "presence": {
            "type": PresenceType.PLAYING,
            "name": "ğŸŒ… ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼",
            "status": PresenceStatus.ONLINE
        },
        "duration": 3600  # 1æ™‚é–“
    })
    
    # æ·±å¤œã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“
    scheduler.add_schedule("night_maintenance", {
        "start_time": time(2, 0),
        "end_time": time(4, 0),
        "presence": {
            "type": PresenceType.PLAYING,
            "name": "ğŸŒ™ æ·±å¤œãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹",
            "status": PresenceStatus.IDLE
        }
    })
    
    # é€±æœ«ã®ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    scheduler.add_schedule("weekend_message", {
        "weekdays": [5, 6],  # åœŸæ—¥
        "presence": {
            "type": PresenceType.PLAYING,
            "name": "ğŸ® é€±æœ«ã‚’æ¥½ã—ã‚‚ã†ï¼",
            "status": PresenceStatus.ONLINE
        }
    })
```

### 4. ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çµ±è¨ˆ

```python
class PresenceStatistics:
    def __init__(self):
        self.presence_history = []
        self.activity_counts = {}
        self.status_duration = {}
        self.last_reset = datetime.now()
    
    def record_presence_change(self, old_presence: Dict, new_presence: Dict):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹å¤‰æ›´ã®è¨˜éŒ²"""
        timestamp = datetime.now()
        
        change_record = {
            "timestamp": timestamp,
            "old_presence": old_presence,
            "new_presence": new_presence
        }
        
        self.presence_history.append(change_record)
        
        # çµ±è¨ˆã®æ›´æ–°
        self.update_statistics(new_presence, timestamp)
        
        # å±¥æ­´ã®åˆ¶é™ï¼ˆæœ€æ–°100ä»¶ã®ã¿ä¿æŒï¼‰
        if len(self.presence_history) > 100:
            self.presence_history = self.presence_history[-100:]
    
    def update_statistics(self, presence: Dict, timestamp: datetime):
        """çµ±è¨ˆã®æ›´æ–°"""
        activity_name = presence.get("name", "Unknown")
        status = presence.get("status", PresenceStatus.ONLINE).name
        
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚«ã‚¦ãƒ³ãƒˆ
        if activity_name not in self.activity_counts:
            self.activity_counts[activity_name] = 0
        self.activity_counts[activity_name] += 1
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¶™ç¶šæ™‚é–“
        if status not in self.status_duration:
            self.status_duration[status] = timedelta()
    
    def get_statistics_summary(self) -> Dict:
        """çµ±è¨ˆã‚µãƒãƒªãƒ¼ã®å–å¾—"""
        total_changes = len(self.presence_history)
        
        # æœ€ã‚‚ä½¿ç”¨ã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
        most_used_activity = max(self.activity_counts.items(), key=lambda x: x[1]) if self.activity_counts else ("None", 0)
        
        # å¹³å‡å¤‰æ›´é–“éš”
        if len(self.presence_history) > 1:
            time_diffs = []
            for i in range(1, len(self.presence_history)):
                diff = self.presence_history[i]["timestamp"] - self.presence_history[i-1]["timestamp"]
                time_diffs.append(diff.total_seconds())
            
            avg_interval = sum(time_diffs) / len(time_diffs)
        else:
            avg_interval = 0
        
        return {
            "total_changes": total_changes,
            "most_used_activity": most_used_activity,
            "average_change_interval": avg_interval,
            "activity_counts": dict(sorted(self.activity_counts.items(), key=lambda x: x[1], reverse=True)),
            "status_duration": self.status_duration,
            "period_start": self.last_reset,
            "period_end": datetime.now()
        }
    
    def reset_statistics(self):
        """çµ±è¨ˆã®ãƒªã‚»ãƒƒãƒˆ"""
        self.presence_history.clear()
        self.activity_counts.clear()
        self.status_duration.clear()
        self.last_reset = datetime.now()
        logger.info("Presence statistics reset")
```

## ç®¡ç†ã‚³ãƒãƒ³ãƒ‰

### 1. ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ç®¡ç†ã‚³ãƒãƒ³ãƒ‰

```python
class PresenceCommands(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.presence_manager = PresenceManager(bot)
        self.event_presence = EventDrivenPresence(self.presence_manager)
        self.scheduler = PresenceScheduler(self.presence_manager)
        self.statistics = PresenceStatistics()
    
    @app_commands.command(name="presence_set", description="ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã‚’è¨­å®š")
    @app_commands.describe(
        activity_type="ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¿ã‚¤ãƒ—",
        name="è¡¨ç¤ºå",
        status="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
        duration="è¡¨ç¤ºæ™‚é–“ï¼ˆç§’ï¼‰"
    )
    async def set_presence(
        self, 
        interaction: discord.Interaction, 
        activity_type: str,
        name: str,
        status: str = "online",
        duration: int = None
    ):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®æ‰‹å‹•è¨­å®š"""
        
        # æ¨©é™ãƒã‚§ãƒƒã‚¯
        if not interaction.user.guild_permissions.manage_guild:
            await interaction.response.send_message("ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
            return
        
        try:
            # ã‚¿ã‚¤ãƒ—ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›
            presence_type = PresenceType[activity_type.upper()]
            presence_status = PresenceStatus[status.upper()]
            
            await self.presence_manager.set_custom_presence(
                presence_type, name, presence_status, duration
            )
            
            embed = discord.Embed(
                title="âœ… ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹è¨­å®šå®Œäº†",
                description=f"ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚",
                color=0x00FF00
            )
            embed.add_field(name="ã‚¿ã‚¤ãƒ—", value=activity_type, inline=True)
            embed.add_field(name="è¡¨ç¤ºå", value=name, inline=True)
            embed.add_field(name="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", value=status, inline=True)
            
            if duration:
                embed.add_field(name="è¡¨ç¤ºæ™‚é–“", value=f"{duration}ç§’", inline=True)
            
            await interaction.response.send_message(embed=embed)
            
        except KeyError as e:
            await interaction.response.send_message(f"ç„¡åŠ¹ãªå€¤ã§ã™: {e}", ephemeral=True)
        except Exception as e:
            logger.error(f"Failed to set presence: {e}")
            await interaction.response.send_message("ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚", ephemeral=True)
    
    @app_commands.command(name="presence_status", description="ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çŠ¶æ…‹ã‚’è¡¨ç¤º")
    async def show_presence_status(self, interaction: discord.Interaction):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çŠ¶æ…‹ã®è¡¨ç¤º"""
        
        info = self.presence_manager.get_current_presence_info()
        
        embed = discord.Embed(
            title="ğŸ“Š ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çŠ¶æ…‹",
            color=0x0099FF
        )
        
        current = info.get("current_presence")
        if current:
            embed.add_field(name="ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£", value=current["name"], inline=False)
            embed.add_field(name="ã‚¿ã‚¤ãƒ—", value=current["type"].name, inline=True)
            embed.add_field(name="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", value=current["status"].name, inline=True)
        
        embed.add_field(name="è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", value="æœ‰åŠ¹" if info["auto_rotation"] else "ç„¡åŠ¹", inline=True)
        embed.add_field(name="ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é–“éš”", value=f"{info['rotation_interval']}ç§’", inline=True)
        
        if info.get("last_update"):
            embed.add_field(name="æœ€çµ‚æ›´æ–°", value=info["last_update"].strftime("%Y-%m-%d %H:%M:%S"), inline=True)
        
        # å‹•çš„æƒ…å ±
        dynamic = info.get("dynamic_info", {})
        embed.add_field(name="ã‚µãƒ¼ãƒãƒ¼æ•°", value=dynamic.get("guild_count", 0), inline=True)
        embed.add_field(name="ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°", value=dynamic.get("user_count", 0), inline=True)
        
        await interaction.response.send_message(embed=embed)
    
    @app_commands.command(name="presence_rotation", description="è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ¶å¾¡")
    @app_commands.describe(
        action="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆenable/disableï¼‰",
        interval="ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é–“éš”ï¼ˆç§’ï¼‰"
    )
    async def control_rotation(
        self, 
        interaction: discord.Interaction, 
        action: str,
        interval: int = None
    ):
        """è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ¶å¾¡"""
        
        # æ¨©é™ãƒã‚§ãƒƒã‚¯
        if not interaction.user.guild_permissions.manage_guild:
            await interaction.response.send_message("ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
            return
        
        if action.lower() == "enable":
            self.presence_manager.enable_auto_rotation()
            if interval:
                self.presence_manager.set_rotation_interval(interval)
            
            embed = discord.Embed(
                title="âœ… è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ–",
                description="ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚",
                color=0x00FF00
            )
            
        elif action.lower() == "disable":
            self.presence_manager.disable_auto_rotation()
            
            embed = discord.Embed(
                title="â¸ï¸ è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–",
                description="ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚",
                color=0xFF9900
            )
            
        else:
            await interaction.response.send_message("ç„¡åŠ¹ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚'enable' ã¾ãŸã¯ 'disable' ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚", ephemeral=True)
            return
        
        if interval:
            embed.add_field(name="ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é–“éš”", value=f"{interval}ç§’", inline=True)
        
        await interaction.response.send_message(embed=embed)
    
    @app_commands.command(name="presence_stats", description="ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çµ±è¨ˆã‚’è¡¨ç¤º")
    async def show_presence_statistics(self, interaction: discord.Interaction):
        """ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çµ±è¨ˆã®è¡¨ç¤º"""
        
        stats = self.statistics.get_statistics_summary()
        
        embed = discord.Embed(
            title="ğŸ“ˆ ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹çµ±è¨ˆ",
            description=f"æœŸé–“: {stats['period_start'].strftime('%Y-%m-%d')} - {stats['period_end'].strftime('%Y-%m-%d')}",
            color=0x0099FF
        )
        
        embed.add_field(name="ç·å¤‰æ›´å›æ•°", value=stats["total_changes"], inline=True)
        embed.add_field(name="å¹³å‡å¤‰æ›´é–“éš”", value=f"{stats['average_change_interval']:.1f}ç§’", inline=True)
        
        # æœ€ã‚‚ä½¿ç”¨ã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
        most_used = stats["most_used_activity"]
        embed.add_field(name="æœ€å¤šä½¿ç”¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£", value=f"{most_used[0]} ({most_used[1]}å›)", inline=False)
        
        # ãƒˆãƒƒãƒ—5ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
        top_activities = list(stats["activity_counts"].items())[:5]
        if top_activities:
            activities_text = "\n".join([f"{i+1}. {name}: {count}å›" for i, (name, count) in enumerate(top_activities)])
            embed.add_field(name="ä½¿ç”¨é »åº¦ãƒˆãƒƒãƒ—5", value=activities_text, inline=False)
        
        await interaction.response.send_message(embed=embed)
```

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ¡ã‚¤ãƒ³ãƒœãƒƒãƒˆã‚¯ãƒ©ã‚¹](../02-core/01-main-bot-class.md)
- [ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ](../02-core/03-logging-system.md)
- [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](../02-core/04-error-handling.md)
- [ç›£è¦–Cogs](../03-cogs/08-monitoring-cogs.md)
